<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Encordados de Raquetas v2.3.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Estilos existentes... */
    </style>
</head>
<body class="p-4 md:p-8">
    <!-- Contenido HTML existente... -->

    <script type="module">
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBWRLU0AWoZtxRGSRNko3U8Rmip5Oz0h30",
            authDomain: "gestion-de-encordados.firebaseapp.com",
            projectId: "gestion-de-encordados",
            storageBucket: "gestion-de-encordados.appspot.com",
            messagingSenderId: "898210321428",
            appId: "1:898210321428:web:08162c1a38e557605dc301",
            measurementId: "G-VJG0HVKMZV"
        };

        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged,
            setPersistence,
            browserLocalPersistence 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            onSnapshot,
            doc, 
            getDoc, 
            updateDoc,
            deleteDoc, 
            Timestamp,
            query,
            where,
            orderBy,
            writeBatch 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ID de la aplicación
        const appId = 'gestion-encordados-v2.3.2';
        
        // Inicialización de Firebase
        let app;
        let auth;
        let db;
        let userId;
        let isAuthReady = false;

        // Referencias a colecciones
        let jugadoresCollectionRef;
        let solicitudesCollectionRef;

        // Suscripciones
        let unsubscribeJugadores = null;
        let unsubscribeSolicitudes = null;
        let unsubscribeJugadoresLista = null;
        
        // Datos actuales
        let currentSolicitudesData = [];

        // --- INICIALIZACIÓN DE FIREBASE ---
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                await setPersistence(auth, browserLocalPersistence);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('userIdDisplay').textContent = userId;
                        
                        // Configurar referencias a colecciones
                        jugadoresCollectionRef = collection(db, `users/${userId}/jugadores`);
                        solicitudesCollectionRef = collection(db, `users/${userId}/solicitudes`);
                        
                        isAuthReady = true;
                        loadInitialData();
                    } else {
                        try {
                            await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Error en autenticación anónima:", error);
                            showModalMessage("Error al conectar con la base de datos", "error");
                        }
                    }
                });
            } catch (error) {
                console.error("Error inicializando Firebase:", error);
                showModalMessage("Error crítico al iniciar la aplicación", "error");
            }
        }

        // --- FUNCIONES DE FECHA MEJORADAS ---
        function formatDateForDisplay(timestamp) {
            if (!timestamp || !timestamp.toDate) return '-';
            const date = timestamp.toDate();
            return date.toLocaleDateString('es-ES');
        }

        function parseDateInput(dateStr) {
            if (!dateStr) return null;
            const date = new Date(dateStr);
            return isNaN(date.getTime()) ? null : date;
        }

        // --- MANEJO DE PESTAÑAS ---
        window.showTab = function(tabId) {
            // Ocultar todas las pestañas
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
            
            // Mostrar la pestaña seleccionada
            const currentTab = document.getElementById(tabId);
            if (currentTab) currentTab.style.display = 'block';
            
            // Resaltar el botón activo
            const currentButton = document.querySelector(`.tab-button[onclick="showTab('${tabId}')"]`);
            if (currentButton) currentButton.classList.add('active'));
            
            if (!isAuthReady) return;

            // Cargar datos según la pestaña
            switch(tabId) {
                case 'verSolicitudesTab': 
                    loadSolicitudes();
                    break;
                case 'estadisticasTab': 
                    calcularYMostrarEstadisticas();
                    break;
                case 'verJugadoresTab': 
                    loadJugadoresParaLista();
                    break;
                case 'nuevaSolicitudTab':
                default:
                    loadJugadoresParaDropdown();
                    break;
            }
        }

        // --- MODALES (sin cambios) ---
        // ...

        // --- VALIDACIÓN DE FORMULARIOS MEJORADA ---
        function validateForm(formData, requiredFields) {
            const errors = [];
            requiredFields.forEach(field => {
                if (!formData[field] || formData[field].toString().trim() === '') {
                    errors.push(`El campo ${field} es obligatorio`);
                }
            });
            return errors;
        }

        // --- GESTIÓN DE JUGADORES CON MÁS VALIDACIONES ---
        const formRegistrarJugador = document.getElementById('formRegistrarJugador');
        formRegistrarJugador.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady) {
                showModalMessage("La base de datos no está lista", "error");
                return;
            }

            const formData = {
                nombreCompleto: formRegistrarJugador.jugadorNombreCompleto.value.trim(),
                telefono: formRegistrarJugador.jugadorTelefono.value.trim(),
                email: formRegistrarJugador.jugadorEmail.value.trim()
            };

            const errors = validateForm(formData, ['nombreCompleto']);
            if (errors.length > 0) {
                showModalMessage(errors.join("<br>"), "error");
                return;
            }

            if (formData.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.email)) {
                showModalMessage("El email no tiene un formato válido", "error");
                return;
            }

            try {
                await addDoc(jugadoresCollectionRef, {
                    ...formData,
                    fechaRegistro: Timestamp.now()
                });
                showModalMessage("Jugador registrado correctamente", "success");
                formRegistrarJugador.reset();
            } catch (error) {
                console.error("Error registrando jugador:", error);
                showModalMessage("Error al registrar jugador", "error");
            }
        });

        // --- GESTIÓN DE SOLICITUDES MEJORADA ---
        const formNuevaSolicitud = document.getElementById('formNuevaSolicitud');
        formNuevaSolicitud.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady) {
                showModalMessage("La base de datos no está lista", "error");
                return;
            }

            const jugadorId = formNuevaSolicitud.jugadorId.value;
            const jugadorSelect = formNuevaSolicitud.jugadorId;
            const nombreJugador = jugadorSelect.options[jugadorSelect.selectedIndex]?.text || "N/A";

            if (!jugadorId) {
                showModalMessage("Debe seleccionar un jugador", "error");
                return;
            }

            const formData = {
                jugadorId,
                nombreJugador,
                marcaRaqueta: formNuevaSolicitud.marcaRaqueta.value.trim(),
                modeloRaqueta: formNuevaSolicitud.modeloRaqueta.value.trim(),
                tensionVertical: parseFloat(formNuevaSolicitud.tensionVertical.value),
                tensionHorizontal: parseFloat(formNuevaSolicitud.tensionHorizontal.value),
                tipoCuerda: formNuevaSolicitud.tipoCuerda.value.trim(),
                cuerdaIncluida: formNuevaSolicitud.cuerdaIncluida.checked,
                fechaSolicitud: parseDateInput(formNuevaSolicitud.fechaSolicitud.value),
                fechaEntregaEstimada: parseDateInput(formNuevaSolicitud.fechaEntregaEstimada.value),
                precio: parseFloat(formNuevaSolicitud.precio.value) || 0,
                estadoPago: formNuevaSolicitud.estadoPago.value,
                estadoEntrega: "Pendiente",
                notas: formNuevaSolicitud.notas.value.trim()
            };

            const errors = validateForm(formData, [
                'marcaRaqueta', 'tensionVertical', 'tensionHorizontal', 
                'fechaSolicitud', 'estadoPago'
            ]);

            if (errors.length > 0) {
                showModalMessage(errors.join("<br>"), "error");
                return;
            }

            try {
                await addDoc(solicitudesCollectionRef, {
                    ...formData,
                    fechaSolicitud: Timestamp.fromDate(formData.fechaSolicitud),
                    fechaEntregaEstimada: formData.fechaEntregaEstimada ? Timestamp.fromDate(formData.fechaEntregaEstimada) : null,
                    fechaCreacion: Timestamp.now(),
                    fechaUltimaActualizacion: Timestamp.now()
                });
                
                showModalMessage("Solicitud registrada correctamente", "success");
                formNuevaSolicitud.reset();
                // Restablecer fecha actual
                document.getElementById('solicitudFechaSolicitud').valueAsDate = new Date();
                actualizarPrecioSugerido('solicitud');
            } catch (error) {
                console.error("Error registrando solicitud:", error);
                showModalMessage("Error al registrar solicitud", "error");
            }
        });

        // --- RESTANTE DEL CÓDIGO (sin cambios significativos) ---
        // loadJugadoresParaDropdown, loadJugadoresParaLista, openEditJugadorModal,
        // formEditJugador, confirmDeleteJugador, loadSolicitudes, openEditSolicitudModal,
        // formEditSolicitud, confirmDeleteSolicitud, import/export CSV, estadísticas, etc.

        // --- INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            showTab('nuevaSolicitudTab');
            
            // Establecer fecha actual por defecto
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('solicitudFechaSolicitud').value = today;
        });
    </script>
</body>
</html>
