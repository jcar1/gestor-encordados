<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Encordados de Raquetas v2.3.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Tailwind gray-100 */
        }
        .tab-button.active {
            border-color: #3b82f6; /* Tailwind blue-500 */
            color: #3b82f6;
            background-color: #eff6ff; /* Tailwind blue-50 */
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fff;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 550px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .table-responsive {
            display: block;
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        select, input[type="text"], input[type="date"], input[type="number"], input[type="email"], textarea, input[type="checkbox"], input[type="file"] {
            border-radius: 0.375rem; /* rounded-md */
        }
        .modal-content form {
            max-height: 75vh; 
            overflow-y: auto; 
            padding-right: 10px; 
        }
        .form-checkbox {
            appearance: none;
            padding: 0;
            display: inline-block;
            width: 1.25em;
            height: 1.25em;
            border: 1px solid #cbd5e1; /* gray-300 */
            border-radius: 0.25rem; /* rounded */
            vertical-align: middle;
            background-color: white;
            cursor: pointer;
            margin-right: 0.5em;
        }
        .form-checkbox:checked {
            background-color: #3b82f6; /* blue-500 */
            border-color: #3b82f6;
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
            background-size: 100% 100%;
            background-position: center;
            background-repeat: no-repeat;
        }
        input[type="file"] {
            padding: 0.5rem;
            border: 1px solid #cbd5e1;
        }
        input[type="file"]::file-selector-button {
            margin-right: 0.5rem;
            border: none;
            background: #3b82f6;
            padding: 0.5rem 0.75rem;
            border-radius: 0.25rem;
            color: #fff;
            cursor: pointer;
            transition: background-color .15s ease-in-out;
        }
        input[type="file"]::file-selector-button:hover {
            background: #2563eb;
        }
        .stat-card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }

    </style>
</head>
<body class="p-4 md:p-8">

    <div class="container mx-auto max-w-7xl bg-white p-6 md:p-8 rounded-xl shadow-2xl">
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">
                <i class="fas fa-racquet mr-2 text-blue-600"></i>Gestor de Encordados
            </h1>
            <p class="text-gray-600 mt-1">Bienvenido. User ID: <span id="userIdDisplay" class="font-semibold">Cargando...</span></p>
        </header>

        <div class="mb-6 border-b border-gray-200">
            <nav class="flex flex-wrap -mb-px" aria-label="Tabs">
                <button onclick="showTab('nuevaSolicitudTab')" class="tab-button active text-sm md:text-base whitespace-nowrap mr-2 py-3 px-4 border-b-2 font-medium rounded-t-lg hover:text-gray-600 hover:border-gray-300">
                    <i class="fas fa-plus-circle mr-1"></i>Nueva Solicitud
                </button>
                <button onclick="showTab('verSolicitudesTab')" class="tab-button text-sm md:text-base whitespace-nowrap mr-2 py-3 px-4 border-b-2 font-medium rounded-t-lg hover:text-gray-600 hover:border-gray-300">
                    <i class="fas fa-list-alt mr-1"></i>Ver Solicitudes
                </button>
                 <button onclick="showTab('estadisticasTab')" class="tab-button text-sm md:text-base whitespace-nowrap mr-2 py-3 px-4 border-b-2 font-medium rounded-t-lg hover:text-gray-600 hover:border-gray-300">
                    <i class="fas fa-chart-pie mr-1"></i>Estadísticas
                </button>
                <button onclick="showTab('registrarJugadorTab')" class="tab-button text-sm md:text-base whitespace-nowrap mr-2 py-3 px-4 border-b-2 font-medium rounded-t-lg hover:text-gray-600 hover:border-gray-300">
                    <i class="fas fa-user-plus mr-1"></i>Registrar Jugador
                </button>
                <button onclick="showTab('verJugadoresTab')" class="tab-button text-sm md:text-base whitespace-nowrap py-3 px-4 border-b-2 font-medium rounded-t-lg hover:text-gray-600 hover:border-gray-300">
                    <i class="fas fa-users mr-1"></i>Ver Jugadores
                </button>
            </nav>
        </div>

        <main>
            <div id="nuevaSolicitudTab" class="tab-content">
                <h2 class="text-2xl font-semibold mb-6 text-gray-700">Crear Nueva Solicitud de Encordado</h2>
                <form id="formNuevaSolicitud" class="space-y-6">
                    <div>
                        <label for="solicitudJugadorId" class="block text-sm font-medium text-gray-700 mb-1">Jugador:</label>
                        <select id="solicitudJugadorId" name="jugadorId" required class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Seleccione un jugador...</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="solicitudMarcaRaqueta" class="block text-sm font-medium text-gray-700 mb-1">Marca de Raqueta:</label>
                            <input type="text" id="solicitudMarcaRaqueta" name="marcaRaqueta" required class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="solicitudModeloRaqueta" class="block text-sm font-medium text-gray-700 mb-1">Modelo de Raqueta:</label>
                            <input type="text" id="solicitudModeloRaqueta" name="modeloRaqueta" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="solicitudTensionVertical" class="block text-sm font-medium text-gray-700 mb-1">Tensión Vertical (lbs/kg):</label>
                            <input type="number" id="solicitudTensionVertical" name="tensionVertical" step="0.1" required class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="solicitudTensionHorizontal" class="block text-sm font-medium text-gray-700 mb-1">Tensión Horizontal (lbs/kg):</label>
                            <input type="number" id="solicitudTensionHorizontal" name="tensionHorizontal" step="0.1" required class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div>
                        <label for="solicitudTipoCuerda" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Cuerda (si la trae el cliente):</label>
                        <input type="text" id="solicitudTipoCuerda" name="tipoCuerda" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="solicitudFechaSolicitud" class="block text-sm font-medium text-gray-700 mb-1">Fecha de Solicitud:</label>
                            <input type="date" id="solicitudFechaSolicitud" name="fechaSolicitud" required class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="solicitudFechaEntregaEstimada" class="block text-sm font-medium text-gray-700 mb-1">Fecha de Entrega Estimada:</label>
                            <input type="date" id="solicitudFechaEntregaEstimada" name="fechaEntregaEstimada" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>

                    <div class="flex items-center mt-2 mb-2">
                        <input type="checkbox" id="solicitudCuerdaIncluida" name="cuerdaIncluida" class="form-checkbox h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="solicitudCuerdaIncluida" class="ml-2 block text-sm font-medium text-gray-700">Cuerda Incluida (suministrada por nosotros)</label>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="solicitudPrecio" class="block text-sm font-medium text-gray-700 mb-1">Precio Sugerido/Final (€):</label>
                            <input type="number" id="solicitudPrecio" name="precio" step="0.01" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                         <div>
                            <label for="solicitudEstadoPago" class="block text-sm font-medium text-gray-700 mb-1">Estado del Pago:</label>
                            <select id="solicitudEstadoPago" name="estadoPago" required class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="Pendiente">Pendiente</option>
                                <option value="Pagado">Pagado</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label for="solicitudNotas" class="block text-sm font-medium text-gray-700 mb-1">Notas Adicionales:</label>
                        <textarea id="solicitudNotas" name="notas" rows="3" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    <div>
                        <button type="submit" class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-150 ease-in-out">
                            <i class="fas fa-save mr-2"></i>Guardar Solicitud
                        </button>
                    </div>
                </form>
            </div>

            <div id="verSolicitudesTab" class="tab-content" style="display: none;">
                <h2 class="text-2xl font-semibold mb-6 text-gray-700">Listado de Solicitudes de Encordado</h2>
                
                <div class="mb-6 p-4 bg-gray-50 rounded-lg shadow">
                    <h3 class="text-lg font-medium text-gray-800 mb-3">Filtrar Solicitudes:</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 items-end">
                        <div>
                            <label for="filtroJugador" class="block text-sm font-medium text-gray-700 mb-1">Por Jugador:</label>
                            <select id="filtroJugador" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Todos los jugadores</option>
                            </select>
                        </div>
                        <div>
                            <label for="filtroEstadoPago" class="block text-sm font-medium text-gray-700 mb-1">Por Estado de Pago:</label>
                            <select id="filtroEstadoPago" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Todos</option>
                                <option value="Pendiente">Pendiente</option>
                                <option value="Pagado">Pagado</option>
                            </select>
                        </div>
                        <div>
                            <label for="filtroEstadoEntrega" class="block text-sm font-medium text-gray-700 mb-1">Por Estado de Entrega:</label>
                            <select id="filtroEstadoEntrega" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Todos</option>
                                <option value="Pendiente">Pendiente de Iniciar</option>
                                <option value="En Proceso">En Proceso</option>
                                <option value="Listo para Recoger">Listo para Recoger</option>
                                <option value="Entregado">Entregado</option>
                                <option value="Cancelado">Cancelado</option>
                            </select>
                        </div>
                        <div>
                            <label for="filtroFechaSolicitudDesde" class="block text-sm font-medium text-gray-700 mb-1">F. Solicitud Desde:</label>
                            <input type="date" id="filtroFechaSolicitudDesde" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="filtroFechaSolicitudHasta" class="block text-sm font-medium text-gray-700 mb-1">F. Solicitud Hasta:</label>
                            <input type="date" id="filtroFechaSolicitudHasta" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="col-span-1 sm:col-span-2 lg:col-span-1 xl:col-auto">
                             <button id="btnAplicarFiltros" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out">
                                <i class="fas fa-filter mr-1"></i>Aplicar
                            </button>
                        </div>
                         <div class="col-span-1 sm:col-span-2 lg:col-span-1 xl:col-auto">
                            <button id="btnLimpiarFiltros" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out">
                                <i class="fas fa-times mr-1"></i>Limpiar
                            </button>
                        </div>
                    </div>
                </div>

                <div class="my-6 p-4 bg-gray-50 rounded-lg shadow">
                    <h3 class="text-lg font-medium text-gray-800 mb-3">Importar / Exportar Solicitudes</h3>
                    <div class="flex flex-col sm:flex-row gap-4 items-start">
                        <div class="flex-1">
                            <label for="importFile" class="block text-sm font-medium text-gray-700 mb-1">Importar desde CSV:</label>
                            <input type="file" id="importFile" accept=".csv" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                            <button id="btnImportCsv" class="mt-2 w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out text-sm">
                                <i class="fas fa-file-import mr-2"></i>Importar Archivo
                            </button>
                        </div>
                        <div class="flex-1 sm:text-right">
                             <label class="block text-sm font-medium text-gray-700 mb-1 sm:invisible">Exportar</label> 
                            <button id="btnExportCsv" class="mt-2 w-full sm:w-auto bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out text-sm">
                                <i class="fas fa-file-export mr-2"></i>Exportar a CSV (Filtradas)
                            </button>
                        </div>
                    </div>
                     <p class="mt-3 text-xs text-gray-500">
                        <strong>Formato CSV esperado para importar:</strong><br>
                        Encabezados: <code>jugadorId,nombreJugador,marcaRaqueta,modeloRaqueta,tensionVertical,tensionHorizontal,tipoCuerda,cuerdaIncluida,fechaSolicitud,fechaEntregaEstimada,precio,estadoPago,estadoEntrega,notas</code><br>
                        <code>cuerdaIncluida</code> debe ser TRUE o FALSE. Fechas como <strong>dd/mm/aaaa</strong>.
                    </p>
                </div>


                <div id="listaSolicitudesContainer" class="table-responsive">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jugador</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Raqueta</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tensión (V/H)</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">F. Solicitud</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">F. Entrega Est.</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Precio (€)</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pago</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Entrega</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="listaSolicitudes" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="9" class="text-center p-4 text-gray-500">Cargando solicitudes...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div id="estadisticasTab" class="tab-content" style="display: none;">
                <h2 class="text-2xl font-semibold mb-6 text-gray-700">Panel de Estadísticas</h2>
                <p class="mb-4 text-sm text-gray-600">Las estadísticas se basan en las solicitudes actualmente visibles (afectadas por los filtros de la pestaña "Ver Solicitudes").</p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="stat-card">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Total Solicitudes</h3>
                        <p id="statTotalSolicitudes" class="text-3xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="stat-card">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Ingresos Totales Estimados</h3>
                        <p id="statIngresosTotales" class="text-3xl font-bold text-green-600">0.00 €</p>
                    </div>
                    <div class="stat-card">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Precio Promedio</h3>
                        <p id="statPrecioPromedio" class="text-3xl font-bold text-indigo-600">0.00 €</p>
                    </div>
                    <div class="stat-card md:col-span-1">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Desglose por Estado de Pago</h3>
                        <ul id="statEstadoPago" class="space-y-1 text-sm">
                            <li>Pendiente: <span class="font-semibold">0</span></li>
                            <li>Pagado: <span class="font-semibold">0</span></li>
                        </ul>
                    </div>
                    <div class="stat-card md:col-span-2">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Desglose por Estado de Entrega</h3>
                        <ul id="statEstadoEntrega" class="space-y-1 text-sm">
                            <li>Pendiente de Iniciar: <span class="font-semibold">0</span></li>
                            <li>En Proceso: <span class="font-semibold">0</span></li>
                            <li>Listo para Recoger: <span class="font-semibold">0</span></li>
                            <li>Entregado: <span class="font-semibold">0</span></li>
                            <li>Cancelado: <span class="font-semibold">0</span></li>
                        </ul>
                    </div>
                </div>
            </div>


            <div id="registrarJugadorTab" class="tab-content" style="display: none;">
                <h2 class="text-2xl font-semibold mb-6 text-gray-700">Registrar Nuevo Jugador</h2>
                <form id="formRegistrarJugador" class="space-y-6">
                    <div>
                        <label for="jugadorNombreCompleto" class="block text-sm font-medium text-gray-700 mb-1">Nombre Completo:</label>
                        <input type="text" id="jugadorNombreCompleto" name="nombreCompleto" required class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="jugadorTelefono" class="block text-sm font-medium text-gray-700 mb-1">Teléfono (Opcional):</label>
                            <input type="text" id="jugadorTelefono" name="telefono" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="jugadorEmail" class="block text-sm font-medium text-gray-700 mb-1">Email (Opcional):</label>
                            <input type="email" id="jugadorEmail" name="email" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div>
                        <button type="submit" class="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-150 ease-in-out">
                            <i class="fas fa-user-check mr-2"></i>Registrar Jugador
                        </button>
                    </div>
                </form>
            </div>

            <div id="verJugadoresTab" class="tab-content" style="display: none;">
                <h2 class="text-2xl font-semibold mb-6 text-gray-700">Listado de Jugadores</h2>
                <div id="listaJugadoresContainer" class="table-responsive">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre Completo</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Teléfono</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">F. Registro</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="listaJugadores" class="bg-white divide-y divide-gray-200">
                           <tr><td colspan="5" class="text-center p-4 text-gray-500">Cargando jugadores...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="messageModal" class="modal">
        <div class="modal-content text-center">
            <p id="modalMessageText" class="text-lg mb-4"></p>
            <button id="modalCloseButton" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg">Cerrar</button>
        </div>
    </div>

    <div id="confirmModal" class="modal">
        <div class="modal-content text-center">
            <p id="confirmModalText" class="text-lg mb-6"></p>
            <div class="flex justify-center space-x-4">
                <button id="confirmModalCancel" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-5 rounded-lg">Cancelar</button>
                <button id="confirmModalConfirm" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-5 rounded-lg">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="editJugadorModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-5">Editar Jugador</h3>
            <form id="formEditJugador" class="space-y-4">
                <input type="hidden" id="editJugadorId">
                <div>
                    <label for="editJugadorNombreCompleto" class="block text-sm font-medium text-gray-700 mb-1">Nombre Completo:</label>
                    <input type="text" id="editJugadorNombreCompleto" name="nombreCompleto" required class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="editJugadorTelefono" class="block text-sm font-medium text-gray-700 mb-1">Teléfono:</label>
                    <input type="text" id="editJugadorTelefono" name="telefono" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="editJugadorEmail" class="block text-sm font-medium text-gray-700 mb-1">Email:</label>
                    <input type="email" id="editJugadorEmail" name="email" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="flex justify-end space-x-3 pt-3">
                    <button type="button" id="cancelEditJugador" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <div id="editSolicitudModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-5">Editar Solicitud de Encordado</h3>
            <form id="formEditSolicitud" class="space-y-4">
                <input type="hidden" id="editSolicitudId">
                
                <div>
                    <label for="editSolicitudJugadorIdDisplay" class="block text-sm font-medium text-gray-700 mb-1">Jugador:</label>
                    <input type="text" id="editSolicitudJugadorIdDisplay" disabled class="w-full p-3 border border-gray-300 rounded-md shadow-sm bg-gray-100">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="editSolicitudMarcaRaqueta" class="block text-sm font-medium text-gray-700 mb-1">Marca Raqueta:</label>
                        <input type="text" id="editSolicitudMarcaRaqueta" required class="w-full p-3 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="editSolicitudModeloRaqueta" class="block text-sm font-medium text-gray-700 mb-1">Modelo Raqueta:</label>
                        <input type="text" id="editSolicitudModeloRaqueta" class="w-full p-3 border border-gray-300 rounded-md shadow-sm">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="editSolicitudTensionVertical" class="block text-sm font-medium text-gray-700 mb-1">Tensión Vertical:</label>
                        <input type="number" id="editSolicitudTensionVertical" step="0.1" required class="w-full p-3 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="editSolicitudTensionHorizontal" class="block text-sm font-medium text-gray-700 mb-1">Tensión Horizontal:</label>
                        <input type="number" id="editSolicitudTensionHorizontal" step="0.1" required class="w-full p-3 border border-gray-300 rounded-md shadow-sm">
                    </div>
                </div>
                
                <div>
                    <label for="editSolicitudTipoCuerda" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Cuerda (si la trae el cliente):</label>
                    <input type="text" id="editSolicitudTipoCuerda" class="w-full p-3 border border-gray-300 rounded-md shadow-sm">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="editSolicitudFechaSolicitud" class="block text-sm font-medium text-gray-700 mb-1">Fecha Solicitud:</label>
                        <input type="date" id="editSolicitudFechaSolicitud" required class="w-full p-3 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="editSolicitudFechaEntregaEstimada" class="block text-sm font-medium text-gray-700 mb-1">Fecha Entrega Est.:</label>
                        <input type="date" id="editSolicitudFechaEntregaEstimada" class="w-full p-3 border border-gray-300 rounded-md shadow-sm">
                    </div>
                </div>
                
                <div class="flex items-center mt-1 mb-1">
                    <input type="checkbox" id="editSolicitudCuerdaIncluida" name="cuerdaIncluida" class="form-checkbox h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="editSolicitudCuerdaIncluida" class="ml-2 block text-sm font-medium text-gray-700">Cuerda Incluida (suministrada por nosotros)</label>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="editSolicitudPrecio" class="block text-sm font-medium text-gray-700 mb-1">Precio Sugerido/Final (€):</label>
                        <input type="number" id="editSolicitudPrecio" step="0.01" class="w-full p-3 border border-gray-300 rounded-md shadow-sm">
                    </div>
                     <div>
                        <label for="editSolicitudEstadoPago" class="block text-sm font-medium text-gray-700 mb-1">Estado Pago:</label>
                        <select id="editSolicitudEstadoPago" required class="w-full p-3 border border-gray-300 rounded-md shadow-sm">
                            <option value="Pendiente">Pendiente</option>
                            <option value="Pagado">Pagado</option>
                        </select>
                    </div>
                </div>
                 <div>
                    <label for="editSolicitudEstadoEntrega" class="block text-sm font-medium text-gray-700 mb-1">Estado Entrega:</label>
                    <select id="editSolicitudEstadoEntrega" required class="w-full p-3 border border-gray-300 rounded-md shadow-sm">
                        <option value="Pendiente">Pendiente de Iniciar</option>
                        <option value="En Proceso">En Proceso</option>
                        <option value="Listo para Recoger">Listo para Recoger</option>
                        <option value="Entregado">Entregado</option>
                        <option value="Cancelado">Cancelado</option>
                    </select>
                </div>
                <div>
                    <label for="editSolicitudNotas" class="block text-sm font-medium text-gray-700 mb-1">Notas Adicionales:</label>
                    <textarea id="editSolicitudNotas" rows="2" class="w-full p-3 border border-gray-300 rounded-md shadow-sm"></textarea>
                </div>

                <div class="flex justify-end space-x-3 pt-3">
                    <button type="button" id="cancelEditSolicitud" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        // Importaciones de Firebase (versión modular)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged,
            setPersistence,
            browserLocalPersistence 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            onSnapshot,
            doc, 
            getDoc, 
            updateDoc,
            deleteDoc, 
            Timestamp,
            query,
            where,
            orderBy,
            writeBatch 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuración de Firebase
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-racket-app-v2.3.2'; // Actualizado ID para esta versión
        
        let app;
        let auth;
        let db;
        let userId;
        let isAuthReady = false;

        let jugadoresCollectionRef;
        let solicitudesCollectionRef;

        let unsubscribeJugadores = null;
        let unsubscribeSolicitudes = null;
        let unsubscribeJugadoresLista = null; 
        
        let currentSolicitudesData = []; 

        // --- INICIALIZACIÓN DE FIREBASE Y AUTENTICACIÓN ---
        async function initializeFirebase() {
            const userIdDisplay = document.getElementById('userIdDisplay'); 

            let effectiveFirebaseConfig;
            if (typeof __firebase_config !== 'undefined' && __firebase_config && __firebase_config.trim() !== '' && __firebase_config.trim() !== '{}') {
                try {
                    effectiveFirebaseConfig = JSON.parse(__firebase_config);
                } catch (e) {
                    console.error("Error parsing __firebase_config:", e);
                    if (userIdDisplay) userIdDisplay.textContent = "Config Inválida (JSON)";
                    showModalMessage("Error en la configuración de Firebase (JSON). La aplicación no funcionará.", "error");
                    return; 
                }
            } else {
                console.warn("Firebase config (__firebase_config) was not provided or was empty/invalid. Ensure your Firebase project's configuration is correctly set up, especially for local testing if not in a Canvas environment.");
                effectiveFirebaseConfig = { 
                    // Ejemplo: Rellena con tu configuración si __firebase_config no está disponible
                    // apiKey: "TU_API_KEY",
                    // authDomain: "TU_PROJECT_ID.firebaseapp.com",
                    // projectId: "TU_PROJECT_ID",
                    // storageBucket: "TU_PROJECT_ID.appspot.com",
                    // messagingSenderId: "TU_SENDER_ID",
                    // appId: "TU_APP_ID"
                }; 
            }

            if (!effectiveFirebaseConfig || !effectiveFirebaseConfig.apiKey || !effectiveFirebaseConfig.authDomain || !effectiveFirebaseConfig.projectId) {
                 console.error("Firebase configuration is missing, empty, or incomplete. App will not function correctly.");
                 if (userIdDisplay) userIdDisplay.textContent = "Configuración de Firebase Incompleta/Faltante";
                 showModalMessage("Configuración de Firebase incompleta o faltante. La aplicación no funcionará correctamente. Verifique la consola para más detalles y asegúrese de que la configuración de su proyecto Firebase esté completa en el código si `__firebase_config` no está disponible.", "error");
                 return; 
            }
            
            try {
                app = initializeApp(effectiveFirebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                console.log("Firebase App, Auth, and Firestore initialized for v" + appId.split('-v')[1]);

                await setPersistence(auth, browserLocalPersistence);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User is signed in with UID:", userId);
                        if (userIdDisplay) userIdDisplay.textContent = userId;
                        
                        jugadoresCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/jugadores`);
                        solicitudesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/solicitudesEncordado`);
                        
                        isAuthReady = true;
                        loadInitialData();
                    } else {
                        console.log("User is signed out. Attempting to sign in...");
                        userId = null; 
                        isAuthReady = false; 
                        if (userIdDisplay) userIdDisplay.textContent = "No autenticado";
                        
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            console.log("Attempting signInWithCustomToken...");
                            try {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } catch (tokenError) {
                                console.error("Error with signInWithCustomToken:", tokenError);
                                console.log("Falling back to signInAnonymously after token error...");
                                try {
                                    await signInAnonymously(auth);
                                } catch (anonError) {
                                    console.error("Error with signInAnonymously after token error:", anonError);
                                    if (userIdDisplay) userIdDisplay.textContent = "Error de autenticación";
                                }
                            }
                        } else {
                            console.log("Attempting signInAnonymously as no token provided...");
                            try {
                                await signInAnonymously(auth);
                            } catch (anonError) {
                                console.error("Error with signInAnonymously:", anonError);
                                if (userIdDisplay) userIdDisplay.textContent = "Error de autenticación";
                            }
                        }
                    }
                });

            } catch (error) { 
                console.error("Error during Firebase initialization or auth setup:", error);
                if (userIdDisplay) userIdDisplay.textContent = "Error de inicialización"; 
                showModalMessage(`Error en Firebase: ${error.message}`, "error");
            }
        }
        
        // --- UTILIDADES DE FECHA ---
        function formatDateForDisplay(timestamp) {
            if (timestamp && timestamp.toDate) {
                const date = timestamp.toDate();
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0'); // Meses son 0-indexados
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            }
            return '-';
        }

        function parseDateFrom_ddmmyyyy(dateStr) {
            if (!dateStr || !/^\d{2}\/\d{2}\/\d{4}$/.test(dateStr)) {
                return null; // Formato inválido
            }
            const parts = dateStr.split('/');
            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1; // Meses en JS son 0-indexados
            const year = parseInt(parts[2], 10);
            if (isNaN(day) || isNaN(month) || isNaN(year)) return null;
            const dateObj = new Date(year, month, day);
            // Validar si la fecha es real (e.g., no 31/02/2024)
            if (dateObj.getFullYear() === year && dateObj.getMonth() === month && dateObj.getDate() === day) {
                return dateObj;
            }
            return null;
        }


        // --- MANEJO DE PESTAÑAS ---
        window.showTab = function(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
            
            const currentTab = document.getElementById(tabId);
            if (currentTab) currentTab.style.display = 'block';
            
            const currentButton = document.querySelector(`.tab-button[onclick="showTab('${tabId}')"]`);
            if (currentButton) currentButton.classList.add('active');
            
            if (!isAuthReady) return;

            if (tabId === 'verSolicitudesTab') loadSolicitudes(); 
            else if (tabId === 'estadisticasTab') calcularYMostrarEstadisticas(); 
            else if (tabId === 'verJugadoresTab') loadJugadoresParaLista(); 
            else if (tabId === 'nuevaSolicitudTab' || tabId === 'verSolicitudesTab' || tabId === 'estadisticasTab') {
                 loadJugadoresParaDropdown(); 
            }
        }

        // --- MODALES ---
        // (Sin cambios, se omite por brevedad)
        const messageModal = document.getElementById('messageModal');
        const modalMessageText = document.getElementById('modalMessageText');
        const modalCloseButton = document.getElementById('modalCloseButton');
        const confirmModal = document.getElementById('confirmModal');
        const confirmModalText = document.getElementById('confirmModalText');
        const confirmModalConfirm = document.getElementById('confirmModalConfirm');
        const confirmModalCancel = document.getElementById('confirmModalCancel');
        const editJugadorModal = document.getElementById('editJugadorModal');
        const formEditJugador = document.getElementById('formEditJugador');
        const cancelEditJugador = document.getElementById('cancelEditJugador');
        const editSolicitudModal = document.getElementById('editSolicitudModal');
        const formEditSolicitud = document.getElementById('formEditSolicitud');
        const cancelEditSolicitud = document.getElementById('cancelEditSolicitud');

        function showModalMessage(message, type = 'info') {
            modalMessageText.textContent = message;
            modalMessageText.classList.remove('text-red-600', 'text-green-600', 'text-yellow-600');
            if (type === 'error') modalMessageText.classList.add('text-red-600');
            else if (type === 'success') modalMessageText.classList.add('text-green-600');
            else if (type === 'warning') modalMessageText.classList.add('text-yellow-600');
            messageModal.style.display = 'flex';
        }
        modalCloseButton.onclick = () => messageModal.style.display = 'none';
        
        let confirmCallback = null;
        function showConfirmModal(message, callback) {
            confirmModalText.textContent = message;
            confirmCallback = callback;
            confirmModal.style.display = 'flex';
        }
        confirmModalConfirm.onclick = () => {
            if (confirmCallback) confirmCallback();
            confirmModal.style.display = 'none';
        };
        confirmModalCancel.onclick = () => confirmModal.style.display = 'none';

        window.onclick = (event) => { 
            if (event.target == messageModal) messageModal.style.display = 'none';
            if (event.target == confirmModal) confirmModal.style.display = 'none';
            if (event.target == editJugadorModal) editJugadorModal.style.display = 'none';
            if (event.target == editSolicitudModal) editSolicitudModal.style.display = 'none';
        };
        cancelEditJugador.onclick = () => editJugadorModal.style.display = 'none';
        cancelEditSolicitud.onclick = () => editSolicitudModal.style.display = 'none';

        // --- LÓGICA DE PRECIOS SUGERIDOS ---
        // (Sin cambios, se omite por brevedad)
        const PRECIO_SOLO_MANO_OBRA = 5;
        const PRECIO_CON_CUERDA = 10;

        function actualizarPrecioSugerido(formIdPrefix) {
            const cuerdaIncluidaCheckbox = document.getElementById(`${formIdPrefix}CuerdaIncluida`);
            const precioInput = document.getElementById(`${formIdPrefix}Precio`);
            if (cuerdaIncluidaCheckbox && precioInput) {
                if (cuerdaIncluidaCheckbox.checked) {
                    precioInput.value = PRECIO_CON_CUERDA;
                } else {
                    precioInput.value = PRECIO_SOLO_MANO_OBRA;
                }
            }
        }
        document.getElementById('solicitudCuerdaIncluida').addEventListener('change', () => actualizarPrecioSugerido('solicitud'));
        document.getElementById('editSolicitudCuerdaIncluida').addEventListener('change', () => actualizarPrecioSugerido('editSolicitud'));

        // --- GESTIÓN DE JUGADORES ---
        // (Sin cambios, se omite por brevedad)
        const formRegistrarJugador = document.getElementById('formRegistrarJugador');
        formRegistrarJugador.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady || !jugadoresCollectionRef) { showModalMessage("Error: La base de datos no está lista o no está autenticado.", "error"); return; }
            const nombreCompleto = formRegistrarJugador.jugadorNombreCompleto.value.trim();
            if (!nombreCompleto) { showModalMessage("El nombre completo del jugador es obligatorio.", "error"); return; }
            try {
                await addDoc(jugadoresCollectionRef, {
                    nombreCompleto,
                    telefono: formRegistrarJugador.jugadorTelefono.value.trim(),
                    email: formRegistrarJugador.jugadorEmail.value.trim(),
                    fechaRegistro: Timestamp.now()
                });
                showModalMessage("Jugador registrado correctamente.", "success");
                formRegistrarJugador.reset();
            } catch (error) { console.error("Error registrando jugador:", error); showModalMessage(`Error al registrar jugador: ${error.message}`, "error"); }
        });

        function loadJugadoresParaDropdown() {
            if (!isAuthReady || !jugadoresCollectionRef) return;
            if (unsubscribeJugadores) unsubscribeJugadores(); 
            unsubscribeJugadores = onSnapshot(query(jugadoresCollectionRef, orderBy("nombreCompleto")), (snapshot) => {
                const solicitudJugadorSelect = document.getElementById('solicitudJugadorId');
                const filtroJugadorSelect = document.getElementById('filtroJugador');
                const currentSolicitudJugador = solicitudJugadorSelect ? solicitudJugadorSelect.value : '';
                const currentFiltroJugador = filtroJugadorSelect ? filtroJugadorSelect.value : '';
                if(solicitudJugadorSelect) solicitudJugadorSelect.innerHTML = '<option value="">Seleccione un jugador...</option>';
                if(filtroJugadorSelect) filtroJugadorSelect.innerHTML = '<option value="">Todos los jugadores</option>';
                snapshot.forEach(docSnap => { 
                    const jugador = { id: docSnap.id, ...docSnap.data() };
                    if(solicitudJugadorSelect){ const option = document.createElement('option'); option.value = jugador.id; option.textContent = jugador.nombreCompleto; solicitudJugadorSelect.appendChild(option); }
                    if(filtroJugadorSelect){ const option = document.createElement('option'); option.value = jugador.id; option.textContent = jugador.nombreCompleto; filtroJugadorSelect.appendChild(option); }
                });
                if (solicitudJugadorSelect && currentSolicitudJugador) solicitudJugadorSelect.value = currentSolicitudJugador;
                if (filtroJugadorSelect && currentFiltroJugador) filtroJugadorSelect.value = currentFiltroJugador;
            }, error => { console.error("Error cargando jugadores para dropdown:", error); });
        }

        function loadJugadoresParaLista() {
            if (!isAuthReady || !jugadoresCollectionRef) return;
            const listaJugadoresBody = document.getElementById('listaJugadores');
            if (!listaJugadoresBody) return;
            listaJugadoresBody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-gray-500">Cargando jugadores...</td></tr>';
            if (unsubscribeJugadoresLista) unsubscribeJugadoresLista(); 
            unsubscribeJugadoresLista = onSnapshot(query(jugadoresCollectionRef, orderBy("nombreCompleto")), (snapshot) => {
                if (snapshot.empty) { listaJugadoresBody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-gray-500">No hay jugadores registrados.</td></tr>'; return; }
                listaJugadoresBody.innerHTML = ''; 
                snapshot.forEach(docSnap => {
                    const jugador = { id: docSnap.id, ...docSnap.data() };
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-50 transition-colors duration-150";
                    tr.innerHTML = `
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${jugador.nombreCompleto}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${jugador.telefono || '-'}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${jugador.email || '-'}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${formatDateForDisplay(jugador.fechaRegistro)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                            <button onclick="openEditJugadorModal('${jugador.id}')" class="text-blue-600 hover:text-blue-900 mr-3 transition-colors duration-150"><i class="fas fa-edit"></i> Editar</button>
                            <button onclick="confirmDeleteJugador('${jugador.id}', '${jugador.nombreCompleto.replace(/'/g, "\\'")}')" class="text-red-600 hover:text-red-900 transition-colors duration-150"><i class="fas fa-trash"></i> Eliminar</button>
                        </td>
                    `;
                    listaJugadoresBody.appendChild(tr);
                });
            }, error => { console.error("Error cargando lista de jugadores:", error); listaJugadoresBody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-red-500">Error al cargar jugadores.</td></tr>'; });
        }
        
        window.openEditJugadorModal = async (jugadorId) => {
            if (!isAuthReady) return;
            try {
                const jugadorDocRef = doc(jugadoresCollectionRef, jugadorId);
                const docSnap = await getDoc(jugadorDocRef);
                if (docSnap.exists()) {
                    const jugador = docSnap.data();
                    formEditJugador.editJugadorId.value = jugadorId;
                    formEditJugador.editJugadorNombreCompleto.value = jugador.nombreCompleto;
                    formEditJugador.editJugadorTelefono.value = jugador.telefono || '';
                    formEditJugador.editJugadorEmail.value = jugador.email || '';
                    editJugadorModal.style.display = 'flex';
                } else { showModalMessage("Jugador no encontrado.", "error"); }
            } catch (error) { showModalMessage(`Error al cargar jugador: ${error.message}`, "error"); }
        };

        formEditJugador.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady) return;
            const jugadorId = formEditJugador.editJugadorId.value;
            const nombreCompleto = formEditJugador.editJugadorNombreCompleto.value.trim();
            if (!nombreCompleto) { showModalMessage("El nombre completo es obligatorio.", "error"); return; }
            try {
                const jugadorDocRef = doc(jugadoresCollectionRef, jugadorId);
                await updateDoc(jugadorDocRef, {
                    nombreCompleto,
                    telefono: formEditJugador.editJugadorTelefono.value.trim(),
                    email: formEditJugador.editJugadorEmail.value.trim(),
                });
                showModalMessage("Jugador actualizado correctamente.", "success");
                editJugadorModal.style.display = 'none';
            } catch (error) { showModalMessage(`Error al actualizar jugador: ${error.message}`, "error"); }
        });

        window.confirmDeleteJugador = (jugadorId, nombreJugador) => {
            const nombreDecodificado = nombreJugador.replace(/\\'/g, "'");
            showConfirmModal(`¿Está seguro de que desea eliminar al jugador "${nombreDecodificado}"? Esta acción no se puede deshacer.`, async () => {
                if (!isAuthReady) return;
                try {
                    await deleteDoc(doc(jugadoresCollectionRef, jugadorId));
                    showModalMessage(`Jugador "${nombreDecodificado}" eliminado correctamente.`, "success");
                } catch (error) { showModalMessage(`Error al eliminar jugador: ${error.message}`, "error"); }
            });
        };

        // --- GESTIÓN DE SOLICITUDES DE ENCORDADO ---
        const formNuevaSolicitud = document.getElementById('formNuevaSolicitud');
        formNuevaSolicitud.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady || !solicitudesCollectionRef || !jugadoresCollectionRef) { showModalMessage("Error: La base de datos no está lista.", "error"); return; }
            const jugadorId = formNuevaSolicitud.jugadorId.value;
            const jugadorSelect = formNuevaSolicitud.jugadorId;
            const nombreJugador = jugadorSelect.options[jugadorSelect.selectedIndex]?.text || "N/A";
            if (!jugadorId) { showModalMessage("Debe seleccionar un jugador.", "error"); return; }
            try {
                const fechaSolicitudRaw = formNuevaSolicitud.fechaSolicitud.value; // YYYY-MM-DD from input
                const fechaEntregaEstimadaRaw = formNuevaSolicitud.fechaEntregaEstimada.value; // YYYY-MM-DD from input

                await addDoc(solicitudesCollectionRef, {
                    jugadorId, nombreJugador,
                    marcaRaqueta: formNuevaSolicitud.marcaRaqueta.value.trim(), modeloRaqueta: formNuevaSolicitud.modeloRaqueta.value.trim(),
                    tensionVertical: parseFloat(formNuevaSolicitud.tensionVertical.value) || null, tensionHorizontal: parseFloat(formNuevaSolicitud.tensionHorizontal.value) || null,
                    tipoCuerda: formNuevaSolicitud.tipoCuerda.value.trim(), cuerdaIncluida: formNuevaSolicitud.cuerdaIncluida.checked, 
                    fechaSolicitud: fechaSolicitudRaw ? Timestamp.fromDate(new Date(fechaSolicitudRaw)) : null, // Direct use of YYYY-MM-DD
                    fechaEntregaEstimada: fechaEntregaEstimadaRaw ? Timestamp.fromDate(new Date(fechaEntregaEstimadaRaw)) : null, // Direct use of YYYY-MM-DD
                    precio: formNuevaSolicitud.precio.value ? parseFloat(formNuevaSolicitud.precio.value) : null,
                    estadoPago: formNuevaSolicitud.estadoPago.value, estadoEntrega: "Pendiente",
                    notas: formNuevaSolicitud.notas.value.trim(), fechaCreacion: Timestamp.now(), fechaUltimaActualizacion: Timestamp.now()
                });
                showModalMessage("Solicitud de encordado registrada.", "success");
                formNuevaSolicitud.reset();
                document.getElementById('solicitudFechaSolicitud').valueAsDate = new Date();
                actualizarPrecioSugerido('solicitud'); 
            } catch (error) { console.error("Error registrando solicitud:", error); showModalMessage(`Error al registrar solicitud: ${error.message}`, "error"); }
        });

        function loadSolicitudes() {
            if (!isAuthReady || !solicitudesCollectionRef) return;
            const listaSolicitudesBody = document.getElementById('listaSolicitudes');
            if (!listaSolicitudesBody) return;
            listaSolicitudesBody.innerHTML = '<tr><td colspan="9" class="text-center p-4 text-gray-500">Cargando solicitudes...</td></tr>';
            
            let conditions = [];
            const filtroJugadorVal = document.getElementById('filtroJugador').value;
            const filtroEstadoPagoVal = document.getElementById('filtroEstadoPago').value;
            const filtroEstadoEntregaVal = document.getElementById('filtroEstadoEntrega').value;
            const filtroFechaDesdeVal = document.getElementById('filtroFechaSolicitudDesde').value; // YYYY-MM-DD
            const filtroFechaHastaVal = document.getElementById('filtroFechaSolicitudHasta').value; // YYYY-MM-DD

            if (filtroJugadorVal) conditions.push(where("jugadorId", "==", filtroJugadorVal));
            if (filtroEstadoPagoVal) conditions.push(where("estadoPago", "==", filtroEstadoPagoVal));
            if (filtroEstadoEntregaVal) conditions.push(where("estadoEntrega", "==", filtroEstadoEntregaVal));
            
            if (filtroFechaDesdeVal) {
                conditions.push(where("fechaSolicitud", ">=", Timestamp.fromDate(new Date(filtroFechaDesdeVal))));
            }
            if (filtroFechaHastaVal) {
                const hastaDate = new Date(filtroFechaHastaVal);
                hastaDate.setDate(hastaDate.getDate() + 1); 
                conditions.push(where("fechaSolicitud", "<", Timestamp.fromDate(hastaDate)));
            }
            
            let q = query(solicitudesCollectionRef, ...conditions, orderBy("fechaCreacion", "desc"));
            if (filtroFechaDesdeVal || filtroFechaHastaVal) { 
                 q = query(solicitudesCollectionRef, ...conditions, orderBy("fechaSolicitud", "desc"), orderBy("fechaCreacion", "desc"));
            }

            if (unsubscribeSolicitudes) unsubscribeSolicitudes();
            unsubscribeSolicitudes = onSnapshot(q, (snapshot) => {
                currentSolicitudesData = []; 
                if (snapshot.empty) {
                    listaSolicitudesBody.innerHTML = '<tr><td colspan="9" class="text-center p-4 text-gray-500">No hay solicitudes que coincidan con los filtros.</td></tr>';
                    calcularYMostrarEstadisticas(); 
                    return;
                }
                listaSolicitudesBody.innerHTML = ''; 
                snapshot.forEach(docSnap => {
                    const solicitud = { id: docSnap.id, ...docSnap.data() };
                    currentSolicitudesData.push(solicitud); 
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-50 transition-colors duration-150";
                    const pagoClass = solicitud.estadoPago === 'Pagado' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                    let entregaClass = 'bg-gray-100 text-gray-800';
                    switch(solicitud.estadoEntrega) {
                        case 'Pendiente': entregaClass = 'bg-red-100 text-red-800'; break;
                        case 'En Proceso': entregaClass = 'bg-blue-100 text-blue-800'; break;
                        case 'Listo para Recoger': entregaClass = 'bg-purple-100 text-purple-800'; break;
                        case 'Entregado': entregaClass = 'bg-green-100 text-green-800'; break;
                        case 'Cancelado': entregaClass = 'bg-gray-400 text-white'; break;
                    }
                    tr.innerHTML = `
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${solicitud.nombreJugador || solicitud.jugadorId}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${solicitud.marcaRaqueta} ${solicitud.modeloRaqueta || ''}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${solicitud.tensionVertical || 'N/A'} / ${solicitud.tensionHorizontal || 'N/A'}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${formatDateForDisplay(solicitud.fechaSolicitud)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${formatDateForDisplay(solicitud.fechaEntregaEstimada)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${solicitud.precio != null ? solicitud.precio.toFixed(2) + '€' : '-'}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${pagoClass}">${solicitud.estadoPago}</span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm">
                             <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${entregaClass}">${solicitud.estadoEntrega}</span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                            <button onclick="openEditSolicitudModal('${solicitud.id}')" class="text-blue-600 hover:text-blue-900 mr-3 transition-colors duration-150"><i class="fas fa-edit"></i> Editar</button>
                            <button onclick="confirmDeleteSolicitud('${solicitud.id}')" class="text-red-600 hover:text-red-900 transition-colors duration-150"><i class="fas fa-trash"></i> Eliminar</button>
                        </td>
                    `;
                    listaSolicitudesBody.appendChild(tr);
                });
                calcularYMostrarEstadisticas(); 
            }, error => {
                console.error("Error cargando solicitudes:", error); currentSolicitudesData = [];
                listaSolicitudesBody.innerHTML = `<tr><td colspan="9" class="text-center p-4 text-red-500">Error al cargar: ${error.message}. Verifique índices.</td></tr>`;
                 if (error.code === 'failed-precondition') { showModalMessage("Error Firestore: Puede necesitar un índice compuesto para esta consulta. Revise la consola del navegador para ver el enlace de creación del índice.", "error"); }
                calcularYMostrarEstadisticas(); 
            });
        }
        
        window.openEditSolicitudModal = async (solicitudId) => {
            if (!isAuthReady) return;
            try {
                const solicitudDocRef = doc(solicitudesCollectionRef, solicitudId);
                const docSnap = await getDoc(solicitudDocRef);
                if (docSnap.exists()) {
                    const s = docSnap.data(); 
                    formEditSolicitud.editSolicitudId.value = solicitudId;
                    document.getElementById('editSolicitudJugadorIdDisplay').value = s.nombreJugador || s.jugadorId; 
                    formEditSolicitud.editSolicitudMarcaRaqueta.value = s.marcaRaqueta || '';
                    formEditSolicitud.editSolicitudModeloRaqueta.value = s.modeloRaqueta || '';
                    formEditSolicitud.editSolicitudTensionVertical.value = s.tensionVertical || '';
                    formEditSolicitud.editSolicitudTensionHorizontal.value = s.tensionHorizontal || '';
                    formEditSolicitud.editSolicitudTipoCuerda.value = s.tipoCuerda || '';
                    formEditSolicitud.editSolicitudCuerdaIncluida.checked = s.cuerdaIncluida || false; 
                    formEditSolicitud.editSolicitudFechaSolicitud.value = s.fechaSolicitud ? new Date(s.fechaSolicitud.toDate()).toISOString().split('T')[0] : '';
                    formEditSolicitud.editSolicitudFechaEntregaEstimada.value = s.fechaEntregaEstimada ? new Date(s.fechaEntregaEstimada.toDate()).toISOString().split('T')[0] : '';
                    formEditSolicitud.editSolicitudPrecio.value = s.precio != null ? s.precio : ''; 
                    formEditSolicitud.editSolicitudEstadoPago.value = s.estadoPago;
                    formEditSolicitud.editSolicitudEstadoEntrega.value = s.estadoEntrega;
                    formEditSolicitud.editSolicitudNotas.value = s.notas || '';
                    editSolicitudModal.style.display = 'flex';
                } else { showModalMessage("Solicitud no encontrada.", "error"); }
            } catch (error) { showModalMessage(`Error al cargar solicitud: ${error.message}`, "error"); }
        };

        formEditSolicitud.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady) return;
            const solicitudId = formEditSolicitud.editSolicitudId.value;
            try {
                const solicitudDocRef = doc(solicitudesCollectionRef, solicitudId);
                const fechaSolicitudRaw = formEditSolicitud.editSolicitudFechaSolicitud.value; // YYYY-MM-DD
                const fechaEntregaEstimadaRaw = formEditSolicitud.editSolicitudFechaEntregaEstimada.value; // YYYY-MM-DD

                await updateDoc(solicitudDocRef, {
                    marcaRaqueta: formEditSolicitud.editSolicitudMarcaRaqueta.value.trim(), modeloRaqueta: formEditSolicitud.editSolicitudModeloRaqueta.value.trim(),
                    tensionVertical: parseFloat(formEditSolicitud.editSolicitudTensionVertical.value) || null, tensionHorizontal: parseFloat(formEditSolicitud.editSolicitudTensionHorizontal.value) || null,
                    tipoCuerda: formEditSolicitud.editSolicitudTipoCuerda.value.trim(), cuerdaIncluida: formEditSolicitud.editSolicitudCuerdaIncluida.checked, 
                    fechaSolicitud: fechaSolicitudRaw ? Timestamp.fromDate(new Date(fechaSolicitudRaw)) : null,
                    fechaEntregaEstimada: fechaEntregaEstimadaRaw ? Timestamp.fromDate(new Date(fechaEntregaEstimadaRaw)) : null,
                    precio: formEditSolicitud.editSolicitudPrecio.value ? parseFloat(formEditSolicitud.editSolicitudPrecio.value) : null,
                    estadoPago: formEditSolicitud.editSolicitudEstadoPago.value, estadoEntrega: formEditSolicitud.editSolicitudEstadoEntrega.value,
                    notas: formEditSolicitud.editSolicitudNotas.value.trim(), fechaUltimaActualizacion: Timestamp.now()
                });
                showModalMessage("Solicitud actualizada correctamente.", "success");
                editSolicitudModal.style.display = 'none';
            } catch (error) { showModalMessage(`Error al actualizar solicitud: ${error.message}`, "error"); }
        });

        window.confirmDeleteSolicitud = (solicitudId) => {
            showConfirmModal(`¿Está seguro de que desea eliminar esta solicitud de encordado? Esta acción no se puede deshacer.`, async () => {
                if (!isAuthReady) return;
                try {
                    await deleteDoc(doc(solicitudesCollectionRef, solicitudId));
                    showModalMessage(`Solicitud eliminada correctamente.`, "success");
                } catch (error) { showModalMessage(`Error al eliminar solicitud: ${error.message}`, "error"); }
            });
        };

        // --- IMPORTAR/EXPORTAR CSV ---
        const btnExportCsv = document.getElementById('btnExportCsv');
        const btnImportCsv = document.getElementById('btnImportCsv');
        const importFile = document.getElementById('importFile');

        function escapeCsvCell(cellData) {
            if (cellData == null) return '';
            const stringData = String(cellData);
            if (stringData.includes(',') || stringData.includes('"') || stringData.includes('\n') || stringData.includes('\r')) {
                return `"${stringData.replace(/"/g, '""')}"`; 
            }
            return stringData;
        }

        btnExportCsv.addEventListener('click', () => {
            if (!isAuthReady || currentSolicitudesData.length === 0) {
                showModalMessage("No hay datos de solicitudes para exportar o no está autenticado.", "warning");
                return;
            }
            const headers = [
                "id", "jugadorId", "nombreJugador", "marcaRaqueta", "modeloRaqueta", 
                "tensionVertical", "tensionHorizontal", "tipoCuerda", "cuerdaIncluida",
                "fechaSolicitud", "fechaEntregaEstimada", "precio", "estadoPago", 
                "estadoEntrega", "notas", "fechaCreacion", "fechaUltimaActualizacion"
            ];
            let csvContent = headers.map(escapeCsvCell).join(",") + "\r\n";
            currentSolicitudesData.forEach(solicitud => {
                const row = [
                    solicitud.id, solicitud.jugadorId, solicitud.nombreJugador, solicitud.marcaRaqueta, solicitud.modeloRaqueta,
                    solicitud.tensionVertical, solicitud.tensionHorizontal, solicitud.tipoCuerda, solicitud.cuerdaIncluida,
                    formatDateForDisplay(solicitud.fechaSolicitud), // Usar dd/mm/yyyy para exportar
                    formatDateForDisplay(solicitud.fechaEntregaEstimada), // Usar dd/mm/yyyy para exportar
                    solicitud.precio, solicitud.estadoPago, solicitud.estadoEntrega, solicitud.notas,
                    formatDateForDisplay(solicitud.fechaCreacion), 
                    formatDateForDisplay(solicitud.fechaUltimaActualizacion)
                ];
                csvContent += row.map(escapeCsvCell).join(",") + "\r\n";
            });
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' }); 
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `solicitudes_encordado_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showModalMessage("Datos exportados a CSV.", "success");
            } else {
                showModalMessage("La exportación CSV no es compatible con su navegador.", "error");
            }
        });

        btnImportCsv.addEventListener('click', async () => {
            if (!isAuthReady || !solicitudesCollectionRef) {
                showModalMessage("La base de datos no está lista o no está autenticado.", "error"); return;
            }
            if (!importFile.files || importFile.files.length === 0) {
                showModalMessage("Por favor, seleccione un archivo CSV para importar.", "warning"); return;
            }
            const file = importFile.files[0];
            const reader = new FileReader();
            reader.onload = async (event) => {
                const csvData = event.target.result;
                const lines = csvData.split(/\r\n|\n/);
                if (lines.length < 2) {
                    showModalMessage("El archivo CSV está vacío o no tiene datos.", "error"); return;
                }
                const expectedHeaders = ["jugadorid", "nombrejugador", "marcaraqueta", "modeloraqueta", "tensionvertical", "tensionhorizontal", "tipocuerda", "cuerdaincluida", "fechasolicitud", "fechaentregaestimada", "precio", "estadopago", "estadoentrega", "notas"];
                const actualHeaders = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/"/g, ''));
                let missingHeaders = [];
                const headerMap = {};
                expectedHeaders.forEach(expHeader => {
                    const index = actualHeaders.indexOf(expHeader);
                    if (index === -1) missingHeaders.push(expHeader); else headerMap[expHeader] = index;
                });
                if (missingHeaders.length > 0) {
                    showModalMessage(`Error: Faltan columnas en CSV: ${missingHeaders.join(", ")}`, "error"); return;
                }
                const batch = writeBatch(db);
                let importCount = 0; let errorCount = 0; const errors = [];
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim() === '') continue;
                    const values = lines[i].split(',').map(v => v.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
                    try {
                        const newSolicitudRef = doc(collection(db, `artifacts/${appId}/users/${userId}/solicitudesEncordado`));
                        const cuerdaIncluidaStr = String(values[headerMap["cuerdaincluida"]]).toLowerCase();
                        const cuerdaIncluida = cuerdaIncluidaStr === 'true' || cuerdaIncluidaStr === 'verdadero' || cuerdaIncluidaStr === '1';
                        
                        const fechaSolicitudObj = parseDateFrom_ddmmyyyy(values[headerMap["fechasolicitud"]]);
                        const fechaEntregaEstimadaObj = parseDateFrom_ddmmyyyy(values[headerMap["fechaentregaestimada"]]);

                        const solicitudData = {
                            jugadorId: values[headerMap["jugadorid"]] || null, nombreJugador: values[headerMap["nombrejugador"]] || "N/A",
                            marcaRaqueta: values[headerMap["marcaraqueta"]] || "", modeloRaqueta: values[headerMap["modeloraqueta"]] || "",
                            tensionVertical: parseFloat(values[headerMap["tensionvertical"]]) || null, tensionHorizontal: parseFloat(values[headerMap["tensionhorizontal"]]) || null,
                            tipoCuerda: values[headerMap["tipocuerda"]] || "", cuerdaIncluida: cuerdaIncluida,
                            fechaSolicitud: fechaSolicitudObj ? Timestamp.fromDate(fechaSolicitudObj) : null,
                            fechaEntregaEstimada: fechaEntregaEstimadaObj ? Timestamp.fromDate(fechaEntregaEstimadaObj) : null,
                            precio: parseFloat(values[headerMap["precio"]]) || null, estadoPago: values[headerMap["estadopago"]] || "Pendiente",
                            estadoEntrega: values[headerMap["estadoentrega"]] || "Pendiente", notas: values[headerMap["notas"]] || "",
                            fechaCreacion: Timestamp.now(), fechaUltimaActualizacion: Timestamp.now()
                        };
                        if (!solicitudData.marcaRaqueta) { errors.push(`Línea ${i+1}: Marca de raqueta es obligatoria.`); errorCount++; continue; }
                        if (!solicitudData.fechaSolicitud) { errors.push(`Línea ${i+1}: Fecha de solicitud inválida (dd/mm/aaaa).`); errorCount++; continue; }
                        batch.set(newSolicitudRef, solicitudData); importCount++;
                    } catch (parseError) {
                        console.error(`Error parseando línea ${i+1}:`, parseError, values); errors.push(`Línea ${i+1}: Error formato (${parseError.message}).`); errorCount++;
                    }
                }
                if (importCount > 0) {
                    try {
                        await batch.commit();
                        let message = `${importCount} solicitudes importadas.`;
                        if (errorCount > 0) message += ` ${errorCount} no importadas.`;
                        showModalMessage(message, "success");
                        if (errors.length > 0) console.warn("Errores importación:\n" + errors.join("\n"));
                    } catch (commitError) {
                        console.error("Error guardando importados:", commitError); showModalMessage(`Error guardando: ${commitError.message}`, "error");
                    }
                } else if (errorCount > 0) {
                     showModalMessage(`${errorCount} solicitudes no importadas. Errores: ${errors.slice(0,3).join('; ')}... (ver consola)`, "error");
                } else {
                    showModalMessage("No se importaron nuevas solicitudes.", "info");
                }
                importFile.value = ''; 
            };
            reader.onerror = () => { showModalMessage("Error al leer el archivo.", "error"); importFile.value = ''; };
            reader.readAsText(file);
        });

        // --- EVENT LISTENERS Y FUNCIONES PARA FILTROS ---
        document.getElementById('btnAplicarFiltros').addEventListener('click', loadSolicitudes);
        document.getElementById('btnLimpiarFiltros').addEventListener('click', () => {
            document.getElementById('filtroJugador').value = '';
            document.getElementById('filtroEstadoPago').value = '';
            document.getElementById('filtroEstadoEntrega').value = '';
            document.getElementById('filtroFechaSolicitudDesde').value = '';
            document.getElementById('filtroFechaSolicitudHasta').value = '';
            loadSolicitudes(); 
        });
        
        // --- ESTADÍSTICAS ---
        // (Sin cambios, se omite por brevedad)
        function calcularYMostrarEstadisticas() {
            if (!isAuthReady) return;
            const totalSolicitudesEl = document.getElementById('statTotalSolicitudes');
            const ingresosTotalesEl = document.getElementById('statIngresosTotales');
            const precioPromedioEl = document.getElementById('statPrecioPromedio');
            const estadoPagoEl = document.getElementById('statEstadoPago');
            const estadoEntregaEl = document.getElementById('statEstadoEntrega');
            if (!totalSolicitudesEl || !currentSolicitudesData) { console.warn("Elementos de estadísticas o datos de solicitudes no disponibles para calcular."); return; }
            const numSolicitudes = currentSolicitudesData.length;
            totalSolicitudesEl.textContent = numSolicitudes;
            let ingresosTotales = 0;
            const conteoEstadoPago = { Pendiente: 0, Pagado: 0 };
            const conteoEstadoEntrega = { Pendiente: 0, "En Proceso": 0, "Listo para Recoger": 0, Entregado: 0, Cancelado: 0 };
            currentSolicitudesData.forEach(s => {
                if (s.precio && typeof s.precio === 'number') { ingresosTotales += s.precio; }
                if (s.estadoPago && conteoEstadoPago.hasOwnProperty(s.estadoPago)) { conteoEstadoPago[s.estadoPago]++; }
                if (s.estadoEntrega && conteoEstadoEntrega.hasOwnProperty(s.estadoEntrega)) { conteoEstadoEntrega[s.estadoEntrega]++; }
            });
            ingresosTotalesEl.textContent = `${ingresosTotales.toFixed(2)} €`;
            precioPromedioEl.textContent = numSolicitudes > 0 ? `${(ingresosTotales / numSolicitudes).toFixed(2)} €` : `0.00 €`;
            estadoPagoEl.innerHTML = `<li>Pendiente: <span class="font-semibold">${conteoEstadoPago.Pendiente}</span></li><li>Pagado: <span class="font-semibold">${conteoEstadoPago.Pagado}</span></li>`;
            estadoEntregaEl.innerHTML = `<li>Pendiente de Iniciar: <span class="font-semibold">${conteoEstadoEntrega.Pendiente}</span></li><li>En Proceso: <span class="font-semibold">${conteoEstadoEntrega["En Proceso"]}</span></li><li>Listo para Recoger: <span class="font-semibold">${conteoEstadoEntrega["Listo para Recoger"]}</span></li><li>Entregado: <span class="font-semibold">${conteoEstadoEntrega.Entregado}</span></li><li>Cancelado: <span class="font-semibold">${conteoEstadoEntrega.Cancelado}</span></li>`;
        }

        // --- CARGA INICIAL DE DATOS Y CONFIGURACIÓN ---
        function loadInitialData() {
            if (!isAuthReady) return;
            console.log("Auth is ready, loading initial data for v" + appId.split('-v')[1]);
            loadJugadoresParaDropdown(); 
            loadSolicitudes(); 
            
            const fechaSolicitudInput = document.getElementById('solicitudFechaSolicitud');
            if (fechaSolicitudInput) {
                 try {
                    fechaSolicitudInput.valueAsDate = new Date();
                } catch (e) {
                    const today = new Date();
                    const year = today.getFullYear(); 
                    const mm = String(today.getMonth() + 1).padStart(2, '0');
                    const dd = String(today.getDate()).padStart(2, '0');
                    fechaSolicitudInput.value = `${year}-${mm}-${dd}`; 
                }
            }
            actualizarPrecioSugerido('solicitud'); 
        }

        // Iniciar la aplicación
        initializeFirebase();
        showTab('nuevaSolicitudTab');

    </script>
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyBWRLU0AWoZtxRGSRNko3U8Rmip5Oz0h30",
  authDomain: "gestion-de-encordados.firebaseapp.com",
  projectId: "gestion-de-encordados",
  storageBucket: "gestion-de-encordados.firebasestorage.app",
  messagingSenderId: "898210321428",
  appId: "1:898210321428:web:08162c1a38e557605dc301",
  measurementId: "G-VJG0HVKMZV"
};
    
</body>
</html>

