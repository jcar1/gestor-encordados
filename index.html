<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Encordados de Raquetas v2.6.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .tab-button.active {
            border-color: #3b82f6;
            color: #3b82f6;
            background-color: #eff6ff;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fff;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 550px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .table-responsive {
            display: block;
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        select, input[type="text"], input[type="date"], input[type="number"], input[type="email"], textarea, input[type="checkbox"], input[type="file"] {
            border-radius: 0.375rem;
        }
        .modal-content form {
            max-height: 75vh;
            overflow-y: auto;
            padding-right: 10px;
        }
        .form-checkbox {
            appearance: none;
            padding: 0;
            display: inline-block;
            width: 1.25em;
            height: 1.25em;
            border: 1px solid #cbd5e1;
            border-radius: 0.25rem;
            vertical-align: middle;
            background-color: white;
            cursor: pointer;
            margin-right: 0.5em;
        }
        .form-checkbox:checked {
            background-color: #3b82f6;
            border-color: #3b82f6;
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
            background-size: 100% 100%;
            background-position: center;
            background-repeat: no-repeat;
        }
        input[type="file"] {
            padding: 0.5rem;
            border: 1px solid #cbd5e1;
        }
        input[type="file"]::file-selector-button {
            margin-right: 0.5rem;
            border: none;
            background: #3b82f6;
            padding: 0.5rem 0.75rem;
            border-radius: 0.25rem;
            color: #fff;
            cursor: pointer;
            transition: background-color .15s ease-in-out;
        }
        input[type="file"]::file-selector-button:hover {
            background: #2563eb;
        }
        .stat-card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }
        .error-message {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        .autocomplete-items {
            position: absolute;
            border: 1px solid #d1d5db;
            border-bottom: none;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
        }
        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            background-color: #fff;
            border-bottom: 1px solid #d1d5db;
        }
        .autocomplete-items div:hover {
            background-color: #e5e7eb;
        }
        .autocomplete-active {
            background-color: #3b82f6 !important;
            color: #ffffff;
        }
        .autocomplete-container {
            position: relative;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .solicitud-checkbox {
            appearance: none;
            width: 1.2em;
            height: 1.2em;
            border: 1px solid #cbd5e1;
            border-radius: 0.25rem;
            background-color: white;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .solicitud-checkbox:checked {
            background-color: #3b82f6;
            border-color: #3b82f6;
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
            background-size: 100% 100%;
            background-position: center;
            background-repeat: no-repeat;
        }
        #selectAllSolicitudes {
            margin-left: 0.5rem;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="container mx-auto max-w-7xl bg-white p-6 md:p-8 rounded-xl shadow-2xl">
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">
                <i class="fas fa-racquet mr-2 text-blue-600"></i>Gestor de Encordados
            </h1>
            <p class="text-gray-600 mt-1">Bienvenido. User ID: <span id="userIdDisplay" class="font-semibold">Cargando...</span></p>
        </header>

        <div class="mb-6 border-b border-gray-200">
            <nav class="flex flex-wrap -mb-px" aria-label="Tabs">
                <button onclick="showTab('nuevaSolicitudTab')" class="tab-button active text-sm md:text-base whitespace-nowrap mr-2 py-3 px-4 border-b-2 font-medium rounded-t-lg hover:text-gray-600 hover:border-gray-300">
                    <i class="fas fa-plus-circle mr-1"></i>Nueva Solicitud
                </button>
                <button onclick="showTab('verSolicitudesTab')" class="tab-button text-sm md:text-base whitespace-nowrap mr-2 py-3 px-4 border-b-2 font-medium rounded-t-lg hover:text-gray-600 hover:border-gray-300">
                    <i class="fas fa-list-alt mr-1"></i>Ver Solicitudes
                </button>
                <button onclick="showTab('estadisticasTab')" class="tab-button text-sm md:text-base whitespace-nowrap mr-2 py-3 px-4 border-b-2 font-medium rounded-t-lg hover:text-gray-600 hover:border-gray-300">
                    <i class="fas fa-chart-pie mr-1"></i>Estadísticas
                </button>
                <button onclick="showTab('registrarJugadorTab')" class="tab-button text-sm md:text-base whitespace-nowrap mr-2 py-3 px-4 border-b-2 font-medium rounded-t-lg hover:text-gray-600 hover:border-gray-300">
                    <i class="fas fa-user-plus mr-1"></i>Registrar Jugador
                </button>
                <button onclick="showTab('verJugadoresTab')" class="tab-button text-sm md:text-base whitespace-nowrap py-3 px-4 border-b-2 font-medium rounded-t-lg hover:text-gray-600 hover:border-gray-300">
                    <i class="fas fa-users mr-1"></i>Ver Jugadores
                </button>
            </nav>
        </div>

        <main>
            <!-- Nueva Solicitud Tab -->
            <div id="nuevaSolicitudTab" class="tab-content">
                <h2 class="text-2xl font-semibold mb-6 text-gray-700">Crear Nueva Solicitud de Encordado</h2>
                <form id="formNuevaSolicitud" class="space-y-6">
                    
                    <div class="autocomplete-container">
                        <label for="solicitudJugadorNombre" class="block text-sm font-medium text-gray-700 mb-1">Buscar Jugador:</label>
                        <input type="text" id="solicitudJugadorNombre" name="jugadorNombre" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Escriba código o nombre...">
                        <input type="hidden" id="solicitudJugadorId" name="jugadorId">
                        <div id="error-jugadorId" class="error-message"></div>
                    </div>
                   
                   <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="solicitudMarcaRaqueta" class="block text-sm font-medium text-gray-700 mb-1">Marca de Raqueta:</label>
                            <input type="text" id="solicitudMarcaRaqueta" name="marcaRaqueta" required class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <div id="error-marcaRaqueta" class="error-message"></div>
                        </div>
                        <div>
                            <label for="solicitudModeloRaqueta" class="block text-sm font-medium text-gray-700 mb-1">Modelo de Raqueta:</label>
                            <input type="text" id="solicitudModeloRaqueta" name="modeloRaqueta" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="solicitudTensionVertical" class="block text-sm font-medium text-gray-700 mb-1">Tensión Vertical (lbs/kg):</label>
                            <input type="number" id="solicitudTensionVertical" name="tensionVertical" step="0.1" required class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <div id="error-tensionVertical" class="error-message"></div>
                        </div>
                        <div>
                            <label for="solicitudTensionHorizontal" class="block text-sm font-medium text-gray-700 mb-1">Tensión Horizontal (lbs/kg):</label>
                            <input type="number" id="solicitudTensionHorizontal" name="tensionHorizontal" step="0.1" required class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <div id="error-tensionHorizontal" class="error-message"></div>
                        </div>
                    </div>
                    <div>
                        <label for="solicitudTipoCuerda" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Cuerda (si la trae el cliente):</label>
                        <input type="text" id="solicitudTipoCuerda" name="tipoCuerda" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="solicitudFechaSolicitud" class="block text-sm font-medium text-gray-700 mb-1">Fecha de Solicitud:</label>
                            <input type="date" id="solicitudFechaSolicitud" name="fechaSolicitud" required class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <div id="error-fechaSolicitud" class="error-message"></div>
                        </div>
                        <div>
                            <label for="solicitudFechaEntregaEstimada" class="block text-sm font-medium text-gray-700 mb-1">Fecha de Entrega Estimada:</label>
                            <input type="date" id="solicitudFechaEntregaEstimada" name="fechaEntregaEstimada" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>

                    <div class="flex items-center mt-2 mb-2">
                        <input type="checkbox" id="solicitudCuerdaIncluida" name="cuerdaIncluida" class="form-checkbox h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="solicitudCuerdaIncluida" class="ml-2 block text-sm font-medium text-gray-700">Cuerda Incluida (suministrada por nosotros)</label>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="solicitudPrecio" class="block text-sm font-medium text-gray-700 mb-1">Precio Sugerido/Final (€):</label>
                            <input type="number" id="solicitudPrecio" name="precio" step="0.01" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="solicitudEstadoPago" class="block text-sm font-medium text-gray-700 mb-1">Estado del Pago:</label>
                            <select id="solicitudEstadoPago" name="estadoPago" required class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="Pendiente">Pendiente</option>
                                <option value="Pagado">Pagado</option>
                            </select>
                            <div id="error-estadoPago" class="error-message"></div>
                        </div>
                        <div>
                            <label for="solicitudFechaPago" class="block text-sm font-medium text-gray-700 mb-1">Fecha de Pago:</label>
                            <input type="date" id="solicitudFechaPago" name="fechaPago" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div>
                        <label for="solicitudNotas" class="block text-sm font-medium text-gray-700 mb-1">Notas Adicionales:</label>
                        <textarea id="solicitudNotas" name="notas" rows="3" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    <div>
                        <button type="submit" class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-150 ease-in-out">
                            <i class="fas fa-save mr-2"></i>Guardar Solicitud
                        </button>
                    </div>
                </form>
            </div>

            <!-- Ver Solicitudes Tab -->
            <div id="verSolicitudesTab" class="tab-content" style="display: none;">
                <h2 class="text-2xl font-semibold mb-6 text-gray-700">Listado de Solicitudes de Encordado</h2>
                
                <div class="mb-6 p-4 bg-gray-50 rounded-lg shadow">
                    <h3 class="text-lg font-medium text-gray-800 mb-3">Filtrar Solicitudes:</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 items-end">
                        <div>
                            <label for="filtroJugador" class="block text-sm font-medium text-gray-700 mb-1">Por Jugador:</label>
                            <select id="filtroJugador" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Todos los jugadores</option>
                            </select>
                        </div>
                        <div>
                            <label for="filtroEstadoPago" class="block text-sm font-medium text-gray-700 mb-1">Por Estado de Pago:</label>
                            <select id="filtroEstadoPago" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Todos</option>
                                <option value="Pendiente">Pendiente</option>
                                <option value="Pagado">Pagado</option>
                            </select>
                        </div>
                        <div>
                            <label for="filtroEstadoEntrega" class="block text-sm font-medium text-gray-700 mb-1">Por Estado de Entrega:</label>
                            <select id="filtroEstadoEntrega" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Todos</option>
                                <option value="Pendiente">Pendiente de Iniciar</option>
                                <option value="En Proceso">En Proceso</option>
                                <option value="Listo para Recoger">Listo para Recoger</option>
                                <option value="Entregado">Entregado</option>
                                <option value="Cancelado">Cancelado</option>
                            </select>
                        </div>
                        <div>
                            <label for="filtroFechaSolicitudDesde" class="block text-sm font-medium text-gray-700 mb-1">F. Solicitud Desde:</label>
                            <input type="date" id="filtroFechaSolicitudDesde" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="filtroFechaSolicitudHasta" class="block text-sm font-medium text-gray-700 mb-1">F. Solicitud Hasta:</label>
                            <input type="date" id="filtroFechaSolicitudHasta" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="col-span-1 sm:col-span-2 lg:col-span-1 xl:col-auto">
                            <button id="btnAplicarFiltros" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out">
                                <i class="fas fa-filter mr-1"></i>Aplicar
                            </button>
                        </div>
                        <div class="col-span-1 sm:col-span-2 lg:col-span-1 xl:col-auto">
                            <button id="btnLimpiarFiltros" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out">
                                <i class="fas fa-times mr-1"></i>Limpiar
                            </button>
                        </div>
                    </div>
                </div>

                <div class="my-6 p-4 bg-gray-50 rounded-lg shadow">
                    <h3 class="text-lg font-medium text-gray-800 mb-3">Importar / Exportar Solicitudes</h3>
                    <div class="flex flex-col sm:flex-row gap-4 items-start">
                        <div class="flex-1">
                            <label for="importFile" class="block text-sm font-medium text-gray-700 mb-1">Importar desde CSV:</label>
                            <input type="file" id="importFile" accept=".csv" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                            <button id="btnImportCsv" class="mt-2 w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out text-sm">
                                <i class="fas fa-file-import mr-2"></i>Importar Archivo
                            </button>
                        </div>
                        <div class="flex-1 sm:text-right">
                            <button id="btnExportCsv" class="mt-2 w-full sm:w-auto bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out text-sm">
                                <i class="fas fa-file-export mr-2"></i>Exportar a CSV (Filtradas)
                            </button>
                        </div>
                        <div class="flex-1 sm:text-right">
                            <button id="btnDeleteSelected" class="mt-2 w-full sm:w-auto bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out text-sm">
                                <i class="fas fa-trash-alt mr-2"></i>Eliminar Seleccionadas
                            </button>
                        </div>
                    </div>
                    <p class="mt-3 text-xs text-gray-500">
                        <strong>Formato CSV esperado para importar:</strong><br>
                        Encabezados: <code>jugadorId,nombreJugador,marcaRaqueta,modeloRaqueta,tensionVertical,tensionHorizontal,tipoCuerda,cuerdaIncluida,fechaSolicitud,fechaEntregaEstimada,precio,estadoPago,estadoEntrega,notas</code><br>
                        <code>cuerdaIncluida</code> debe ser TRUE o FALSE. Fechas como <strong>dd/mm/aaaa</strong>.
                    </p>
                </div>

                <div id="listaSolicitudesContainer" class="table-responsive">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <input type="checkbox" id="selectAllSolicitudes" class="form-checkbox h-4 w-4">
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jugador</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Raqueta</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tensión (V/H)</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">F. Solicitud</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">F. Entrega Est.</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Precio (€)</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pago</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Entrega</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="listaSolicitudes" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="10" class="text-center p-4 text-gray-500">Cargando solicitudes...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Estadísticas Tab -->
            <div id="estadisticasTab" class="tab-content" style="display: none;">
                <h2 class="text-2xl font-semibold mb-6 text-gray-700">Panel de Estadísticas</h2>
                <p class="mb-4 text-sm text-gray-600">Las estadísticas se basan en las solicitudes actualmente visibles (afectadas por los filtros de la pestaña "Ver Solicitudes").</p>
                
                <!-- Tarjetas de resumen -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <div class="stat-card">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Total Solicitudes</h3>
                        <p id="statTotalSolicitudes" class="text-3xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="stat-card">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Ingresos Totales</h3>
                        <p id="statIngresosTotales" class="text-3xl font-bold text-green-600">0.00 €</p>
                    </div>
                    <div class="stat-card">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Precio Promedio</h3>
                        <p id="statPrecioPromedio" class="text-3xl font-bold text-indigo-600">0.00 €</p>
                    </div>
                    <div class="stat-card">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Solicitudes Hoy</h3>
                        <p id="statSolicitudesHoy" class="text-3xl font-bold text-purple-600">0</p>
                    </div>
                </div>
                
                <!-- Gráficos principales -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Gráfico de estado de pago -->
                    <div class="stat-card">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Estado de Pago</h3>
                        <div class="chart-container">
                            <canvas id="pagoChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Gráfico de estado de entrega -->
                    <div class="stat-card">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Estado de Entrega</h3>
                        <div class="chart-container">
                            <canvas id="entregaChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Gráficos secundarios -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Gráfico de ingresos mensuales -->
                    <div class="stat-card">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Ingresos Mensuales</h3>
                        <div class="chart-container">
                            <canvas id="ingresosChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Gráfico de solicitudes por jugador -->
                    <div class="stat-card">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Top 5 Jugadores</h3>
                        <div class="chart-container">
                            <canvas id="jugadoresChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Registrar Jugador Tab -->
            <div id="registrarJugadorTab" class="tab-content" style="display: none;">
                <h2 class="text-2xl font-semibold mb-6 text-gray-700">Registrar Nuevo Jugador</h2>
                <form id="formRegistrarJugador" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="jugadorCodigo" class="block text-sm font-medium text-gray-700 mb-1">Código de Jugador:</label>
                            <input type="text" id="jugadorCodigo" name="codigo" required class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <div id="error-codigo" class="error-message"></div>
                        </div>
                        <div>
                            <label for="jugadorNombreCompleto" class="block text-sm font-medium text-gray-700 mb-1">Nombre Completo:</label>
                            <input type="text" id="jugadorNombreCompleto" name="nombreCompleto" required class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <div id="error-nombreCompleto" class="error-message"></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="jugadorTelefono" class="block text-sm font-medium text-gray-700 mb-1">Teléfono (Opcional):</label>
                            <input type="text" id="jugadorTelefono" name="telefono" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="jugadorEmail" class="block text-sm font-medium text-gray-700 mb-1">Email (Opcional):</label>
                            <input type="email" id="jugadorEmail" name="email" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <div id="error-email" class="error-message"></div>
                        </div>
                    </div>
                    
                    <div class="border-t border-gray-200 pt-4">
                        <h3 class="text-lg font-medium text-gray-800 mb-4">Preferencias de Raqueta</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="jugadorMarcaRaqueta" class="block text-sm font-medium text-gray-700 mb-1">Marca de Raqueta:</label>
                                <input type="text" id="jugadorMarcaRaqueta" name="marcaRaqueta" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="jugadorModeloRaqueta" class="block text-sm font-medium text-gray-700 mb-1">Modelo de Raqueta:</label>
                                <input type="text" id="jugadorModeloRaqueta" name="modeloRaqueta" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                            <div>
                                <label for="jugadorTensionVertical" class="block text-sm font-medium text-gray-700 mb-1">Tensión Vertical (lbs/kg):</label>
                                <input type="number" id="jugadorTensionVertical" name="tensionVertical" step="0.1" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="jugadorTensionHorizontal" class="block text-sm font-medium text-gray-700 mb-1">Tensión Horizontal (lbs/kg):</label>
                                <input type="number" id="jugadorTensionHorizontal" name="tensionHorizontal" step="0.1" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        <div class="mt-4">
                            <label for="jugadorTipoCuerda" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Cuerda Preferida:</label>
                            <input type="text" id="jugadorTipoCuerda" name="tipoCuerda" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    
                    <div>
                        <button type="submit" class="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-150 ease-in-out">
                            <i class="fas fa-user-check mr-2"></i>Registrar Jugador
                        </button>
                    </div>
                </form>
            </div>

            <!-- Ver Jugadores Tab -->
            <div id="verJugadoresTab" class="tab-content" style="display: none;">
                <h2 class="text-2xl font-semibold mb-6 text-gray-700">Listado de Jugadores</h2>
                <div id="listaJugadoresContainer" class="table-responsive">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Código</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre Completo</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Teléfono</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Raqueta</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">F. Registro</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="listaJugadores" class="bg-white divide-y divide-gray-200">
                           <tr><td colspan="7" class="text-center p-4 text-gray-500">Cargando jugadores...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Modales -->
    <div id="messageModal" class="modal">
        <div class="modal-content text-center">
            <p id="modalMessageText" class="text-lg mb-4"></p>
            <button id="modalCloseButton" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg">Cerrar</button>
        </div>
    </div>

    <div id="confirmModal" class="modal">
        <div class="modal-content text-center">
            <p id="confirmModalText" class="text-lg mb-6"></p>
            <div class="flex justify-center space-x-4">
                <button id="confirmModalCancel" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-5 rounded-lg">Cancelar</button>
                <button id="confirmModalConfirm" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-5 rounded-lg">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="editJugadorModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-5">Editar Jugador</h3>
            <form id="formEditJugador" class="space-y-4">
                <input type="hidden" id="editJugadorId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="editJugadorCodigo" class="block text-sm font-medium text-gray-700 mb-1">Código de Jugador:</label>
                        <input type="text" id="editJugadorCodigo" name="codigo" required class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <div id="error-editCodigo" class="error-message"></div>
                    </div>
                    <div>
                        <label for="editJugadorNombreCompleto" class="block text-sm font-medium text-gray-700 mb-1">Nombre Completo:</label>
                        <input type="text" id="editJugadorNombreCompleto" name="nombreCompleto" required class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <div id="error-editNombreCompleto" class="error-message"></div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="editJugadorTelefono" class="block text-sm font-medium text-gray-700 mb-1">Teléfono:</label>
                        <input type="text" id="editJugadorTelefono" name="telefono" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="editJugadorEmail" class="block text-sm font-medium text-gray-700 mb-1">Email:</label>
                        <input type="email" id="editJugadorEmail" name="email" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <div id="error-editEmail" class="error-message"></div>
                    </div>
                </div>
                
                <div class="border-t border-gray-200 pt-4">
                    <h3 class="text-lg font-medium text-gray-800 mb-4">Preferencias de Raqueta</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="editJugadorMarcaRaqueta" class="block text-sm font-medium text-gray-700 mb-1">Marca de Raqueta:</label>
                            <input type="text" id="editJugadorMarcaRaqueta" name="marcaRaqueta" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="editJugadorModeloRaqueta" class="block text-sm font-medium text-gray-700 mb-1">Modelo de Raqueta:</label>
                            <input type="text" id="editJugadorModeloRaqueta" name="modeloRaqueta" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div>
                            <label for="editJugadorTensionVertical" class="block text-sm font-medium text-gray-700 mb-1">Tensión Vertical (lbs/kg):</label>
                            <input type="number" id="editJugadorTensionVertical" name="tensionVertical" step="0.1" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="editJugadorTensionHorizontal" class="block text-sm font-medium text-gray-700 mb-1">Tensión Horizontal (lbs/kg):</label>
                            <input type="number" id="editJugadorTensionHorizontal" name="tensionHorizontal" step="0.1" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div class="mt-4">
                        <label for="editJugadorTipoCuerda" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Cuerda Preferida:</label>
                        <input type="text" id="editJugadorTipoCuerda" name="tipoCuerda" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 pt-3">
                    <button type="button" id="cancelEditJugador" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <div id="editSolicitudModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-5">Editar Solicitud de Encordado</h3>
            <form id="formEditSolicitud" class="space-y-4">
                <input type="hidden" id="editSolicitudId">
                
                <div>
                    <label for="editSolicitudJugadorIdDisplay" class="block text-sm font-medium text-gray-700 mb-1">Jugador:</label>
                    <input type="text" id="editSolicitudJugadorIdDisplay" disabled class="w-full p-3 border border-gray-300 rounded-md shadow-sm bg-gray-100">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="editSolicitudMarcaRaqueta" class="block text-sm font-medium text-gray-700 mb-1">Marca Raqueta:</label>
                        <input type="text" id="editSolicitudMarcaRaqueta" required class="w-full p-3 border border-gray-300 rounded-md shadow-sm">
                        <div id="error-editMarcaRaqueta" class="error-message"></div>
                    </div>
                    <div>
                        <label for="editSolicitudModeloRaqueta" class="block text-sm font-medium text-gray-700 mb-1">Modelo Raqueta:</label>
                        <input type="text" id="editSolicitudModeloRaqueta" class="w-full p-3 border border-gray-300 rounded-md shadow-sm">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="editSolicitudTensionVertical" class="block text-sm font-medium text-gray-700 mb-1">Tensión Vertical:</label>
                        <input type="number" id="editSolicitudTensionVertical" step="0.1" required class="w-full p-3 border border-gray-300 rounded-md shadow-sm">
                        <div id="error-editTensionVertical" class="error-message"></div>
                    </div>
                    <div>
                        <label for="editSolicitudTensionHorizontal" class="block text-sm font-medium text-gray-700 mb-1">Tensión Horizontal:</label>
                        <input type="number" id="editSolicitudTensionHorizontal" step="0.1" required class="w-full p-3 border border-gray-300 rounded-md shadow-sm">
                        <div id="error-editTensionHorizontal" class="error-message"></div>
                    </div>
                </div>
                
                <div>
                    <label for="editSolicitudTipoCuerda" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Cuerda (si la trae el cliente):</label>
                    <input type="text" id="editSolicitudTipoCuerda" class="w-full p-3 border border-gray-300 rounded-md shadow-sm">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="editSolicitudFechaSolicitud" class="block text-sm font-medium text-gray-700 mb-1">Fecha Solicitud:</label>
                        <input type="date" id="editSolicitudFechaSolicitud" required class="w-full p-3 border border-gray-300 rounded-md shadow-sm">
                        <div id="error-editFechaSolicitud" class="error-message"></div>
                    </div>
                    <div>
                        <label for="editSolicitudFechaEntregaEstimada" class="block text-sm font-medium text-gray-700 mb-1">Fecha Entrega Est.:</label>
                        <input type="date" id="editSolicitudFechaEntregaEstimada" class="w-full p-3 border border-gray-300 rounded-md shadow-sm">
                    </div>
                </div>
                
                <div class="flex items-center mt-1 mb-1">
                    <input type="checkbox" id="editSolicitudCuerdaIncluida" name="cuerdaIncluida" class="form-checkbox h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="editSolicitudCuerdaIncluida" class="ml-2 block text-sm font-medium text-gray-700">Cuerda Incluida (suministrada por nosotros)</label>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="editSolicitudPrecio" class="block text-sm font-medium text-gray-700 mb-1">Precio Sugerido/Final (€):</label>
                        <input type="number" id="editSolicitudPrecio" step="0.01" class="w-full p-3 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="editSolicitudEstadoPago" class="block text-sm font-medium text-gray-700 mb-1">Estado Pago:</label>
                        <select id="editSolicitudEstadoPago" required class="w-full p-3 border border-gray-300 rounded-md shadow-sm">
                            <option value="Pendiente">Pendiente</option>
                            <option value="Pagado">Pagado</option>
                        </select>
                        <div id="error-editEstadoPago" class="error-message"></div>
                    </div>
                    <div>
                        <label for="editSolicitudFechaPago" class="block text-sm font-medium text-gray-700 mb-1">Fecha de Pago:</label>
                        <input type="date" id="editSolicitudFechaPago" class="w-full p-3 border border-gray-300 rounded-md shadow-sm">
                    </div>
                </div>
                <div>
                    <label for="editSolicitudEstadoEntrega" class="block text-sm font-medium text-gray-700 mb-1">Estado Entrega:</label>
                    <select id="editSolicitudEstadoEntrega" required class="w-full p-3 border border-gray-300 rounded-md shadow-sm">
                        <option value="Pendiente">Pendiente de Iniciar</option>
                        <option value="En Proceso">En Proceso</option>
                        <option value="Listo para Recoger">Listo para Recoger</option>
                        <option value="Entregado">Entregado</option>
                        <option value="Cancelado">Cancelado</option>
                    </select>
                </div>
                <div>
                    <label for="editSolicitudNotas" class="block text-sm font-medium text-gray-700 mb-1">Notas Adicionales:</label>
                    <textarea id="editSolicitudNotas" rows="2" class="w-full p-3 border border-gray-300 rounded-md shadow-sm"></textarea>
                </div>

                <div class="flex justify-end space-x-3 pt-3">
                    <button type="button" id="cancelEditSolicitud" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
    // Configuración de Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyBWRLU0AWoZtxRGSRNko3U8Rmip5Oz0h30",
        authDomain: "gestion-de-encordados.firebaseapp.com",
        projectId: "gestion-de-encordados",
        storageBucket: "gestion-de-encordados.appspot.com",
        messagingSenderId: "898210321428",
        appId: "1:898210321428:web:08162c1a38e557605dc301",
        measurementId: "G-VJG0HVKMZV"
    };

    // Credenciales fijas
    const FIXED_CREDENTIALS = {
        email: "jcsueca@gmail.com",
        password: "A123456!"
    };

    // Importaciones de Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
        getAuth, 
        signInWithEmailAndPassword,
        setPersistence,
        browserLocalPersistence,
        onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { 
        getFirestore, 
        collection, 
        doc,
        getDoc,
        setDoc,
        updateDoc,
        deleteDoc,
        getDocs,
        query,
        where,
        orderBy,
        Timestamp,
        writeBatch,
        addDoc,
        onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Inicialización de Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Referencias a colecciones
    let jugadoresCollectionRef;
    let solicitudesCollectionRef;
    let userId = null;
    let isAuthReady = false;

    // Variables para gráficos
    let pagoChart = null;
    let entregaChart = null;
    let ingresosChart = null;
    let jugadoresChart = null;

    // Función de autenticación
    async function authenticateUser() {
        try {
            await setPersistence(auth, browserLocalPersistence);
            const userCredential = await signInWithEmailAndPassword(
                auth, 
                FIXED_CREDENTIALS.email, 
                FIXED_CREDENTIALS.password
            );
            return userCredential.user;
        } catch (error) {
            console.error("Error de autenticación:", error);
            
            // Mostrar mensaje más descriptivo
            let errorMessage = "Error de autenticación";
            if (error.code === 'auth/invalid-credential') {
                errorMessage = "Credenciales inválidas. Verifica el email y contraseña.";
            } else if (error.code === 'auth/too-many-requests') {
                errorMessage = "Demasiados intentos. Por favor espera e intenta más tarde.";
            }
            
            showModalMessage(errorMessage, "error");
            return null;
        }
    }

    // Función principal de inicialización
    async function initApplication() {
        try {
            const user = await authenticateUser();
            if (user) {
                userId = user.uid;
                document.getElementById('userIdDisplay').textContent = userId;
                
                // Configurar referencias a la base de datos
                jugadoresCollectionRef = collection(db, `users/${userId}/jugadores`);
                solicitudesCollectionRef = collection(db, `users/${userId}/solicitudes`);
                
                isAuthReady = true;
                
                // Cargar datos iniciales con manejo de errores
                try {
                    await loadInitialData();
                    showTab('nuevaSolicitudTab');
                } catch (loadError) {
                    console.error("Error cargando datos iniciales:", loadError);
                    showModalMessage("Error al cargar datos iniciales", "error");
                }
            }
        } catch (error) {
            console.error("Error inicializando la aplicación:", error);
            document.getElementById('userIdDisplay').textContent = "Error de conexión";
            console.error("Error al iniciar la aplicación:", error);
            showModalMessage("Error al iniciar la aplicación: " + (error.message || error), "error");
        }
    }

    // Observador de estado de autenticación
    onAuthStateChanged(auth, (user) => {
        if (user) {
            userId = user.uid;
            document.getElementById('userIdDisplay').textContent = userId;
            console.log("Usuario autenticado con ID:", userId);
            
            if (!isAuthReady) {
                // Configurar referencias a la base de datos
                jugadoresCollectionRef = collection(db, `users/${userId}/jugadores`);
                solicitudesCollectionRef = collection(db, `users/${userId}/solicitudes`);
                
                isAuthReady = true;
                loadInitialData();
            }
        } else {
            console.log("Usuario no autenticado");
            document.getElementById('userIdDisplay').textContent = "No autenticado";
            // Intentar autenticar si no hay usuario
            authenticateUser();
        }
    });

    function checkAuth() {
        if (!isAuthReady) {
            showModalMessage("La aplicación no está autenticada correctamente", "error");
            return false;
        }
        return true;
    }

    function loadJugadoresParaDropdown() {
        if (!checkAuth() || !jugadoresCollectionRef) return;

        getDocs(query(jugadoresCollectionRef, orderBy("nombreCompleto"))).then(snapshot => {
            jugadoresData = [];
            snapshot.forEach(doc => {
                jugadoresData.push({ id: doc.id, ...doc.data() });
            });

            // Activar autocompletado luego de tener los datos cargados
            setupAutocomplete();
        }).catch(error => {
            console.error("Error cargando jugadores para dropdown:", error);
            showModalMessage("Error al cargar jugadores", "error");
        });
    }

    function loadJugadoresParaFiltros() {
        if (!isAuthReady || !jugadoresCollectionRef) return;
        
        const filtroJugador = document.getElementById('filtroJugador');
        if (!filtroJugador) return;
        
        // Limpiar opciones excepto la primera
        while (filtroJugador.options.length > 1) {
            filtroJugador.remove(1);
        }
        
        getDocs(query(jugadoresCollectionRef, orderBy("nombreCompleto"))).then(snapshot => {
            snapshot.forEach(doc => {
                const jugador = doc.data();
                const option = document.createElement('option');
                option.value = doc.id;
                option.textContent = `${jugador.codigo} - ${jugador.nombreCompleto}`;
                filtroJugador.appendChild(option);
            });
        }).catch(error => {
            console.error("Error cargando jugadores para filtros:", error);
        });
    }

    // Inicialización principal
    async function iniciarAplicacion() {
        try {
            const user = await authenticateUser();
            if (user) {
                userId = user.uid;
                document.getElementById('userIdDisplay').textContent = userId;
                
                // Configurar referencias a la base de datos
                jugadoresCollectionRef = collection(db, `users/${userId}/jugadores`);
                solicitudesCollectionRef = collection(db, `users/${userId}/solicitudes`);
                
                isAuthReady = true;
                loadInitialData();
                showTab('nuevaSolicitudTab');
            }
        } catch (error) {
            console.error("Error inicializando la aplicación:", error);
            document.getElementById('userIdDisplay').textContent = "Error de conexión";
        }
    }

    // Suscripciones
    let unsubscribeJugadores = null;
    let unsubscribeSolicitudes = null;
    let unsubscribeJugadoresLista = null;
    
    // Datos actuales
    let currentSolicitudesData = [];
    let jugadoresData = [];

    // --- FUNCIONES DE FECHA MEJORADAS ---
    function formatDateForDisplay(timestamp) {
        if (!timestamp || !timestamp.toDate) return '-';
        const date = timestamp.toDate();
        return date.toLocaleDateString('es-ES');
    }

    function parseDateInput(dateStr) {
        if (!dateStr) return null;
        const date = new Date(dateStr);
        return isNaN(date.getTime()) ? null : date;
    }

    // --- MANEJO DE PESTAÑAS ---
    window.showTab = function(tabId) {
        // Ocultar todas las pestañas
        document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
        document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
        
        // Mostrar la pestaña seleccionada
        const currentTab = document.getElementById(tabId);
        if (currentTab) currentTab.style.display = 'block';
        
        // Resaltar el botón activo
        const currentButton = document.querySelector(`.tab-button[onclick="showTab('${tabId}')"]`);
        if (currentButton) currentButton.classList.add('active');
        
        if (!isAuthReady) return;

        // Cargar datos según la pestaña
        switch(tabId) {
            case 'verSolicitudesTab': 
                loadSolicitudes();
                break;
            case 'estadisticasTab': 
                calcularYMostrarEstadisticas();
                break;
            case 'verJugadoresTab': 
                loadJugadoresParaLista();
                break;
            case 'nuevaSolicitudTab':
            default:
                loadJugadoresParaDropdown();
                break;
        }
    }

    // --- MODALES ---
    const messageModal = document.getElementById('messageModal');
    const modalMessageText = document.getElementById('modalMessageText');
    const modalCloseButton = document.getElementById('modalCloseButton');
    const confirmModal = document.getElementById('confirmModal');
    const confirmModalText = document.getElementById('confirmModalText');
    const confirmModalConfirm = document.getElementById('confirmModalConfirm');
    const confirmModalCancel = document.getElementById('confirmModalCancel');
    const editJugadorModal = document.getElementById('editJugadorModal');
    const formEditJugador = document.getElementById('formEditJugador');
    const cancelEditJugador = document.getElementById('cancelEditJugador');
    const editSolicitudModal = document.getElementById('editSolicitudModal');
    const formEditSolicitud = document.getElementById('formEditSolicitud');
    const cancelEditSolicitud = document.getElementById('cancelEditSolicitud');

    function showModalMessage(message, type = 'info') {
        modalMessageText.textContent = message;
        modalMessageText.className = 'text-lg mb-4';
        
        if (type === 'error') modalMessageText.classList.add('text-red-600');
        else if (type === 'success') modalMessageText.classList.add('text-green-600');
        else if (type === 'warning') modalMessageText.classList.add('text-yellow-600');
        
        messageModal.style.display = 'flex';
    }

    modalCloseButton.onclick = () => messageModal.style.display = 'none';
    
    let confirmCallback = null;
    function showConfirmModal(message, callback) {
        confirmModalText.textContent = message;
        confirmCallback = callback;
        confirmModal.style.display = 'flex';
    }

    confirmModalConfirm.onclick = () => {
        if (confirmCallback) confirmCallback();
        confirmModal.style.display = 'none';
    };

    confirmModalCancel.onclick = () => confirmModal.style.display = 'none';

    window.onclick = (event) => { 
        if (event.target == messageModal) messageModal.style.display = 'none';
        if (event.target == confirmModal) confirmModal.style.display = 'none';
        if (event.target == editJugadorModal) editJugadorModal.style.display = 'none';
        if (event.target == editSolicitudModal) editSolicitudModal.style.display = 'none';
    };

    cancelEditJugador.onclick = () => editJugadorModal.style.display = 'none';
    cancelEditSolicitud.onclick = () => editSolicitudModal.style.display = 'none';

    // --- VALIDACIÓN DE FORMULARIOS ---
    function validateForm(formData, requiredFields) {
        const errors = [];
        requiredFields.forEach(field => {
            if (!formData[field] || formData[field].toString().trim() === '') {
                errors.push(`El campo ${field} es obligatorio`);
            }
        });
        return errors;
    }

    function clearErrorMessages(formId) {
        document.querySelectorAll(`#${formId} .error-message`).forEach(el => {
            el.textContent = '';
        });
    }

    function showError(fieldId, message) {
        const errorElement = document.getElementById(`error-${fieldId}`);
        if (errorElement) {
            errorElement.textContent = message;
        }
    }

    // --- PRECIOS SUGERIDOS ---
    const PRECIO_SOLO_MANO_OBRA = 5;
    const PRECIO_CON_CUERDA = 10;

    function actualizarPrecioSugerido(formIdPrefix) {
        const cuerdaIncluidaCheckbox = document.getElementById(`${formIdPrefix}CuerdaIncluida`);
        const precioInput = document.getElementById(`${formIdPrefix}Precio`);
        if (cuerdaIncluidaCheckbox && precioInput) {
            if (cuerdaIncluidaCheckbox.checked) {
                precioInput.value = PRECIO_CON_CUERDA;
            } else {
                precioInput.value = PRECIO_SOLO_MANO_OBRA;
            }
        }
    }

    document.getElementById('solicitudCuerdaIncluida').addEventListener('change', () => actualizarPrecioSugerido('solicitud'));
    document.getElementById('editSolicitudCuerdaIncluida').addEventListener('change', () => actualizarPrecioSugerido('editSolicitud'));

    // --- AUTOCOMPLETADO DE JUGADORES ---
    function setupAutocomplete() {
        const input = document.getElementById('solicitudJugadorNombre');
        const hiddenInput = document.getElementById('solicitudJugadorId');
        const autocompleteContainer = document.createElement('div');
        autocompleteContainer.className = 'autocomplete-items';
        input.parentNode.appendChild(autocompleteContainer);

        input.addEventListener('input', function() {
            const val = this.value.trim().toLowerCase();
            autocompleteContainer.innerHTML = '';
            
            if (val.length < 2) {
                hiddenInput.value = '';
                return;
            }

            const matches = jugadoresData.filter(jugador => 
                jugador.nombreCompleto.toLowerCase().includes(val) || 
                jugador.codigo.toLowerCase().includes(val)
            ).slice(0, 5);

            if (matches.length === 0) {
                const noResults = document.createElement('div');
                noResults.textContent = 'No se encontraron jugadores';
                autocompleteContainer.appendChild(noResults);
                return;
            }

            matches.forEach(jugador => {
                const item = document.createElement('div');
                item.innerHTML = `<strong>${jugador.codigo}</strong> - ${jugador.nombreCompleto}`;
                item.addEventListener('click', function() {
                    input.value = jugador.nombreCompleto;
                    hiddenInput.value = jugador.id;
                    autocompleteContainer.innerHTML = '';
                    
                    // Autocompletar datos de raqueta
                    document.getElementById('solicitudMarcaRaqueta').value = jugador.marcaRaqueta || '';
                    document.getElementById('solicitudModeloRaqueta').value = jugador.modeloRaqueta || '';
                    document.getElementById('solicitudTensionVertical').value = jugador.tensionVertical || '';
                    document.getElementById('solicitudTensionHorizontal').value = jugador.tensionHorizontal || '';
                    document.getElementById('solicitudTipoCuerda').value = jugador.tipoCuerda || '';
                });
                autocompleteContainer.appendChild(item);
            });
        });

        document.addEventListener('click', function(e) {
            if (e.target !== input) {
                autocompleteContainer.innerHTML = '';
            }
        });
    }

    // --- GESTIÓN DE JUGADORES ---
    const formRegistrarJugador = document.getElementById('formRegistrarJugador');
    formRegistrarJugador.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!isAuthReady) {
            showModalMessage("La base de datos no está lista", "error");
            return;
        }

        clearErrorMessages('formRegistrarJugador');

        const formData = {
            codigo: formRegistrarJugador.jugadorCodigo.value.trim(),
            nombreCompleto: formRegistrarJugador.jugadorNombreCompleto.value.trim(),
            telefono: formRegistrarJugador.jugadorTelefono.value.trim(),
            email: formRegistrarJugador.jugadorEmail.value.trim(),
            marcaRaqueta: formRegistrarJugador.jugadorMarcaRaqueta.value.trim(),
            modeloRaqueta: formRegistrarJugador.jugadorModeloRaqueta.value.trim(),
            tensionVertical: parseFloat(formRegistrarJugador.jugadorTensionVertical.value) || null,
            tensionHorizontal: parseFloat(formRegistrarJugador.jugadorTensionHorizontal.value) || null,
            fechaPago: parseDateInput(document.getElementById('editSolicitudFechaPago').value),
            tipoCuerda: formRegistrarJugador.jugadorTipoCuerda.value.trim()
        };

        // Validaciones
        const errors = validateForm(formData, ['codigo', 'nombreCompleto']);
        
        if (formData.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.email)) {
            errors.push("El email no tiene un formato válido");
            showError('email', "El email no tiene un formato válido");
        }

        // Verificar si el código ya existe
        const codigoExists = jugadoresData.some(j => j.codigo === formData.codigo && j.id !== formRegistrarJugador.jugadorId?.value);
        if (codigoExists) {
            errors.push("El código de jugador ya existe");
            showError('codigo', "Este código ya está en uso");
        }

        // Verificar si el nombre ya existe
        const nombreExists = jugadoresData.some(j => j.nombreCompleto.toLowerCase() === formData.nombreCompleto.toLowerCase() && j.id !== formRegistrarJugador.jugadorId?.value);
        if (nombreExists) {
            errors.push("El nombre de jugador ya existe");
            showError('nombreCompleto', "Este nombre ya está registrado");
        }

        if (errors.length > 0) {
            showModalMessage(errors.join("<br>"), "error");
            return;
        }

        try {
            await addDoc(jugadoresCollectionRef, {
                ...formData,
                fechaRegistro: Timestamp.now()
            });
            showModalMessage("Jugador registrado correctamente", "success");
            formRegistrarJugador.reset();
        } catch (error) {
            console.error("Error registrando jugador:", error);
            showModalMessage("Error al registrar jugador", "error");
        }
    });

    
    function loadJugadoresParaLista() {
        if (!isAuthReady || !jugadoresCollectionRef) return;
        
        const listaJugadoresBody = document.getElementById('listaJugadores');
        if (!listaJugadoresBody) return;
        
        listaJugadoresBody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-gray-500">Cargando jugadores...</td></tr>';
        
        if (unsubscribeJugadoresLista) unsubscribeJugadoresLista();
        
        unsubscribeJugadoresLista = onSnapshot(
            query(jugadoresCollectionRef, orderBy("nombreCompleto")), 
            (snapshot) => {
                jugadoresData = [];
                
                if (snapshot.empty) {
                    listaJugadoresBody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-gray-500">No hay jugadores registrados.</td></tr>';
                    return;
                }
                
                listaJugadoresBody.innerHTML = '';
                
                snapshot.forEach(docSnap => {
                    const jugador = { id: docSnap.id, ...docSnap.data() };
                    jugadoresData.push(jugador);
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-50 transition-colors duration-150";
                    
                    tr.innerHTML = `
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-700">${jugador.codigo}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-700">${jugador.nombreCompleto}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${jugador.telefono || '-'}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${jugador.email || '-'}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                            ${jugador.marcaRaqueta || '-'} ${jugador.modeloRaqueta ? `(${jugador.modeloRaqueta})` : ''}
                            ${jugador.tensionVertical ? `${jugador.tensionVertical}/${jugador.tensionHorizontal || '?'} lbs` : ''}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${formatDateForDisplay(jugador.fechaRegistro)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                            <button onclick="openEditJugadorModal('${jugador.id}')" class="text-blue-600 hover:text-blue-900 mr-3 transition-colors duration-150">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button onclick="confirmDeleteJugador('${jugador.id}', '${jugador.nombreCompleto.replace(/'/g, "\\'")}')" class="text-red-600 hover:text-red-900 transition-colors duration-150">
                                <i class="fas fa-trash"></i> Eliminar
                            </button>
                        </td>
                    `;
                    
                    listaJugadoresBody.appendChild(tr);
                });
            }, 
            error => {
                console.error("Error cargando lista de jugadores:", error);
                listaJugadoresBody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-red-500">Error al cargar jugadores.</td></tr>';
            }
        );
    }
    
    window.openEditJugadorModal = async (jugadorId) => {
        if (!isAuthReady) return;
        
        try {
            const jugadorDocRef = doc(jugadoresCollectionRef, jugadorId);
            const docSnap = await getDoc(jugadorDocRef);
            
            if (docSnap.exists()) {
                const jugador = docSnap.data();
                
                formEditJugador.editJugadorId.value = jugadorId;
                formEditJugador.editJugadorCodigo.value = jugador.codigo;
                formEditJugador.editJugadorNombreCompleto.value = jugador.nombreCompleto;
                formEditJugador.editJugadorTelefono.value = jugador.telefono || '';
                formEditJugador.editJugadorEmail.value = jugador.email || '';
                formEditJugador.editJugadorMarcaRaqueta.value = jugador.marcaRaqueta || '';
                formEditJugador.editJugadorModeloRaqueta.value = jugador.modeloRaqueta || '';
                formEditJugador.editJugadorTensionVertical.value = jugador.tensionVertical || '';
                formEditJugador.editJugadorTensionHorizontal.value = jugador.tensionHorizontal || '';
                formEditJugador.editJugadorTipoCuerda.value = jugador.tipoCuerda || '';
                
                editJugadorModal.style.display = 'flex';
            } else {
                showModalMessage("Jugador no encontrado.", "error");
            }
        } catch (error) {
            showModalMessage(`Error al cargar jugador: ${error.message}`, "error");
        }
    };

    formEditJugador.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!isAuthReady) return;
        
        clearErrorMessages('formEditJugador');

        const jugadorId = formEditJugador.editJugadorId.value;
        const codigo = formEditJugador.editJugadorCodigo.value.trim();
        const nombreCompleto = formEditJugador.editJugadorNombreCompleto.value.trim();
        const email = formEditJugador.editJugadorEmail.value.trim();
        
        // Validaciones
        if (!codigo) {
            showError('editCodigo', "El código de jugador es obligatorio");
            return;
        }
        
        if (!nombreCompleto) {
            showError('editNombreCompleto', "El nombre completo es obligatorio");
            return;
        }
        
        if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
            showError('editEmail', "El email no tiene un formato válido");
            return;
        }

        // Verificar si el código ya existe (excluyendo el jugador actual)
        const codigoExists = jugadoresData.some(j => j.codigo === codigo && j.id !== jugadorId);
        if (codigoExists) {
            showError('editCodigo', "Este código ya está en uso");
            return;
        }

        // Verificar si el nombre ya existe (excluyendo el jugador actual)
        const nombreExists = jugadoresData.some(j => j.nombreCompleto.toLowerCase() === nombreCompleto.toLowerCase() && j.id !== jugadorId);
        if (nombreExists) {
            showError('editNombreCompleto', "Este nombre ya está registrado");
            return;
        }

        try {
            const jugadorDocRef = doc(jugadoresCollectionRef, jugadorId);
            
            await updateDoc(jugadorDocRef, {
                codigo,
                nombreCompleto,
                telefono: formEditJugador.editJugadorTelefono.value.trim(),
                email,
                marcaRaqueta: formEditJugador.editJugadorMarcaRaqueta.value.trim(),
                modeloRaqueta: formEditJugador.editJugadorModeloRaqueta.value.trim(),
                tensionVertical: parseFloat(formEditJugador.editJugadorTensionVertical.value) || null,
                tensionHorizontal: parseFloat(formEditJugador.editJugadorTensionHorizontal.value) || null,
                tipoCuerda: formEditJugador.editJugadorTipoCuerda.value.trim(),
                fechaUltimaActualizacion: Timestamp.now()
            });
            
            showModalMessage("Jugador actualizado correctamente.", "success");
            editJugadorModal.style.display = 'none';
        } catch (error) {
            showModalMessage(`Error al actualizar jugador: ${error.message}`, "error");
        }
    });

    window.confirmDeleteJugador = (jugadorId, nombreJugador) => {
        const nombreDecodificado = nombreJugador.replace(/\\'/g, "'");
        
        showConfirmModal(
            `¿Está seguro de que desea eliminar al jugador "${nombreDecodificado}"? Esta acción no se puede deshacer.`, 
            async () => {
                if (!isAuthReady) return;
                
                try {
                    // Verificar si el jugador tiene solicitudes asociadas
                    const q = query(solicitudesCollectionRef, where("jugadorId", "==", jugadorId));
                    const querySnapshot = await getDocs(q);
                    
                    if (!querySnapshot.empty) {
                        showModalMessage("No se puede eliminar el jugador porque tiene solicitudes asociadas.", "error");
                        return;
                    }
                    
                    await deleteDoc(doc(jugadoresCollectionRef, jugadorId));
                    showModalMessage(`Jugador "${nombreDecodificado}" eliminado correctamente.`, "success");
                } catch (error) {
                    showModalMessage(`Error al eliminar jugador: ${error.message}`, "error");
                }
            }
        );
    };

    // --- GESTIÓN DE SOLICITUDES DE ENCORDADO ---
    const formNuevaSolicitud = document.getElementById('formNuevaSolicitud');
    formNuevaSolicitud.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const jugadorId = formNuevaSolicitud.jugadorId.value;
        const jugadorNombre = formNuevaSolicitud.jugadorNombre.value.trim();

        if (!jugadorId || !jugadorNombre) {
            showError('jugadorId', "Debe seleccionar un jugador válido");
            return;
        }

        const formData = {
            jugadorId,
            nombreJugador: jugadorNombre,
            marcaRaqueta: formNuevaSolicitud.marcaRaqueta.value.trim(),
            modeloRaqueta: formNuevaSolicitud.modeloRaqueta.value.trim(),
            tensionVertical: parseFloat(formNuevaSolicitud.tensionVertical.value),
            tensionHorizontal: parseFloat(formNuevaSolicitud.tensionHorizontal.value),
            tipoCuerda: formNuevaSolicitud.tipoCuerda.value.trim(),
            cuerdaIncluida: formNuevaSolicitud.cuerdaIncluida.checked,
            fechaSolicitud: parseDateInput(formNuevaSolicitud.fechaSolicitud.value),
            fechaEntregaEstimada: parseDateInput(formNuevaSolicitud.fechaEntregaEstimada.value),
            fechaPago: parseDateInput(formNuevaSolicitud.fechaPago.value),
            precio: parseFloat(formNuevaSolicitud.precio.value) || 0,
            estadoPago: formNuevaSolicitud.estadoPago.value,
            estadoEntrega: "Pendiente",
            notas: formNuevaSolicitud.notas.value.trim()
        };

        // Validaciones
        const errors = validateForm(formData, [
            'marcaRaqueta', 'tensionVertical', 'tensionHorizontal', 
            'fechaSolicitud', 'estadoPago'
        ]);

        if (isNaN(formData.tensionVertical)) {
            errors.push("La tensión vertical debe ser un número válido");
            showError('tensionVertical', "Debe ser un número válido");
        }

        if (isNaN(formData.tensionHorizontal)) {
            errors.push("La tensión horizontal debe ser un número válido");
            showError('tensionHorizontal', "Debe ser un número válido");
        }

        if (!formData.fechaSolicitud) {
            errors.push("La fecha de solicitud no es válida");
            showError('fechaSolicitud', "Fecha no válida");
        }

        if (errors.length > 0) {
            showModalMessage(errors.join("<br>"), "error");
            return;
        }

        try {
            await addDoc(solicitudesCollectionRef, {
                ...formData,
                fechaSolicitud: Timestamp.fromDate(formData.fechaSolicitud),
                fechaEntregaEstimada: formData.fechaEntregaEstimada ? Timestamp.fromDate(formData.fechaEntregaEstimada) : null,
                fechaCreacion: Timestamp.now(),
                fechaUltimaActualizacion: Timestamp.now()
            });
            
            showModalMessage("Solicitud registrada correctamente", "success");
            formNuevaSolicitud.reset();
            // Restablecer fecha actual
            document.getElementById('solicitudFechaSolicitud').valueAsDate = new Date();
            actualizarPrecioSugerido('solicitud');
            // Limpiar autocompletado
            document.getElementById('solicitudJugadorNombre').value = '';
            document.getElementById('solicitudJugadorId').value = '';
        } catch (error) {
            console.error("Error registrando solicitud:", error);
            showModalMessage("Error al registrar solicitud", "error");
        }
    });

    function loadSolicitudes() {
        if (!isAuthReady || !solicitudesCollectionRef) return;
        
        const listaSolicitudesBody = document.getElementById('listaSolicitudes');
        if (!listaSolicitudesBody) return;
        
        listaSolicitudesBody.innerHTML = '<tr><td colspan="10" class="text-center p-4 text-gray-500">Cargando solicitudes...</td></tr>';
        
        let conditions = [];
        
        // Aplicar filtros
        const filtroJugadorVal = document.getElementById('filtroJugador').value;
        const filtroEstadoPagoVal = document.getElementById('filtroEstadoPago').value;
        const filtroEstadoEntregaVal = document.getElementById('filtroEstadoEntrega').value;
        const filtroFechaDesdeVal = document.getElementById('filtroFechaSolicitudDesde').value;
        const filtroFechaHastaVal = document.getElementById('filtroFechaSolicitudHasta').value;

        if (filtroJugadorVal) conditions.push(where("jugadorId", "==", filtroJugadorVal));
        if (filtroEstadoPagoVal) conditions.push(where("estadoPago", "==", filtroEstadoPagoVal));
        if (filtroEstadoEntregaVal) conditions.push(where("estadoEntrega", "==", filtroEstadoEntregaVal));
        
        if (filtroFechaDesdeVal) {
            conditions.push(where("fechaSolicitud", ">=", Timestamp.fromDate(new Date(filtroFechaDesdeVal))));
        }
        
        if (filtroFechaHastaVal) {
            const hastaDate = new Date(filtroFechaHastaVal);
            hastaDate.setDate(hastaDate.getDate() + 1);
            conditions.push(where("fechaSolicitud", "<", Timestamp.fromDate(hastaDate)));
        }
        
        // Crear consulta
        let q;
        if (filtroFechaDesdeVal || filtroFechaHastaVal) {
            q = query(
                solicitudesCollectionRef, 
                ...conditions, 
                orderBy("fechaSolicitud", "desc"), 
                orderBy("fechaCreacion", "desc")
            );
        } else {
            q = query(
                solicitudesCollectionRef, 
                ...conditions, 
                orderBy("fechaCreacion", "desc")
            );
        }

        if (unsubscribeSolicitudes) unsubscribeSolicitudes();
        
        unsubscribeSolicitudes = onSnapshot(q, 
            (snapshot) => {
                currentSolicitudesData = [];
                
                if (snapshot.empty) {
                    listaSolicitudesBody.innerHTML = '<tr><td colspan="10" class="text-center p-4 text-gray-500">No hay solicitudes que coincidan con los filtros.</td></tr>';
                    calcularYMostrarEstadisticas();
                    return;
                }
                
                listaSolicitudesBody.innerHTML = '';
                
                snapshot.forEach(docSnap => {
                    const solicitud = { id: docSnap.id, ...docSnap.data() };
                    currentSolicitudesData.push(solicitud);
                    
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-50 transition-colors duration-150";
                    
                    const pagoClass = solicitud.estadoPago === 'Pagado' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                    
                    let entregaClass = 'bg-gray-100 text-gray-800';
                    switch(solicitud.estadoEntrega) {
                        case 'Pendiente': entregaClass = 'bg-red-100 text-red-800'; break;
                        case 'En Proceso': entregaClass = 'bg-blue-100 text-blue-800'; break;
                        case 'Listo para Recoger': entregaClass = 'bg-purple-100 text-purple-800'; break;
                        case 'Entregado': entregaClass = 'bg-green-100 text-green-800'; break;
                        case 'Cancelado': entregaClass = 'bg-gray-400 text-white'; break;
                    }
                    
                    tr.innerHTML = `
                        <td class="px-4 py-3 whitespace-nowrap">
                            <input type="checkbox" class="solicitud-checkbox form-checkbox h-4 w-4" value="${solicitud.id}">
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${solicitud.nombreJugador || solicitud.jugadorId}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${solicitud.marcaRaqueta} ${solicitud.modeloRaqueta || ''}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${solicitud.tensionVertical || 'N/A'} / ${solicitud.tensionHorizontal || 'N/A'}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${formatDateForDisplay(solicitud.fechaSolicitud)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${formatDateForDisplay(solicitud.fechaEntregaEstimada)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${solicitud.precio != null ? solicitud.precio.toFixed(2) + '€' : '-'}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${pagoClass}">${solicitud.estadoPago}</span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${entregaClass}">${solicitud.estadoEntrega}</span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                            <button onclick="openEditSolicitudModal('${solicitud.id}')" class="text-blue-600 hover:text-blue-900 mr-3 transition-colors duration-150">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button onclick="confirmDeleteSolicitud('${solicitud.id}')" class="text-red-600 hover:text-red-900 transition-colors duration-150">
                                <i class="fas fa-trash"></i> Eliminar
                            </button>
                        </td>
                    `;
                    
                    listaSolicitudesBody.appendChild(tr);
                });
                
                // Manejar el evento de seleccionar todos
                document.getElementById('selectAllSolicitudes').addEventListener('change', function() {
                    const checkboxes = document.querySelectorAll('.solicitud-checkbox');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = this.checked;
                    });
                });

                // Manejar cuando se deselecciona un checkbox individual
                listaSolicitudesBody.addEventListener('change', (e) => {
                    if (e.target.classList.contains('solicitud-checkbox')) {
                        const allChecked = document.querySelectorAll('.solicitud-checkbox:checked').length;
                        const totalCheckboxes = document.querySelectorAll('.solicitud-checkbox').length;
                        document.getElementById('selectAllSolicitudes').checked = allChecked === totalCheckboxes && totalCheckboxes > 0;
                    }
                });
                
                calcularYMostrarEstadisticas();
            }, 
            (error) => {
                console.error("Error cargando solicitudes:", error);
                currentSolicitudesData = [];
                listaSolicitudesBody.innerHTML = `<tr><td colspan="10" class="text-center p-4 text-red-500">Error al cargar: ${error.message}</td></tr>`;
                
                if (error.code === 'failed-precondition') {
                    showModalMessage("Error: Puede necesitar crear un índice compuesto en Firestore para esta consulta.", "error");
                }
                
                calcularYMostrarEstadisticas();
            }
        );
    }
    
    window.openEditSolicitudModal = async (solicitudId) => {
        if (!isAuthReady) return;
        
        try {
            const solicitudDocRef = doc(solicitudesCollectionRef, solicitudId);
            const docSnap = await getDoc(solicitudDocRef);
            
            if (docSnap.exists()) {
                const s = docSnap.data();
                
                formEditSolicitud.editSolicitudId.value = solicitudId;
                document.getElementById('editSolicitudJugadorIdDisplay').value = s.nombreJugador || s.jugadorId;
                formEditSolicitud.editSolicitudMarcaRaqueta.value = s.marcaRaqueta || '';
                formEditSolicitud.editSolicitudModeloRaqueta.value = s.modeloRaqueta || '';
                formEditSolicitud.editSolicitudTensionVertical.value = s.tensionVertical || '';
                formEditSolicitud.editSolicitudTensionHorizontal.value = s.tensionHorizontal || '';
                formEditSolicitud.editSolicitudTipoCuerda.value = s.tipoCuerda || '';
                formEditSolicitud.editSolicitudCuerdaIncluida.checked = s.cuerdaIncluida || false;
                
                formEditSolicitud.editSolicitudFechaSolicitud.value = s.fechaSolicitud ? 
                    new Date(s.fechaSolicitud.toDate()).toISOString().split('T')[0] : '';
                
                formEditSolicitud.editSolicitudFechaEntregaEstimada.value = s.fechaEntregaEstimada ? 
                    new Date(s.fechaEntregaEstimada.toDate()).toISOString().split('T')[0] : '';
                
                formEditSolicitud.editSolicitudPrecio.value = s.precio != null ? s.precio : '';
                formEditSolicitud.editSolicitudEstadoPago.value = s.estadoPago;
                formEditSolicitud.editSolicitudEstadoEntrega.value = s.estadoEntrega;
                formEditSolicitud.editSolicitudNotas.value = s.notas || '';
                
                editSolicitudModal.style.display = 'flex';
            } else {
                showModalMessage("Solicitud no encontrada.", "error");
            }
        } catch (error) {
            showModalMessage(`Error al cargar solicitud: ${error.message}`, "error");
        }
    };

    formEditSolicitud.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!isAuthReady) return;
        
        clearErrorMessages('formEditSolicitud');

        const solicitudId = formEditSolicitud.editSolicitudId.value;
        
        const formData = {
            marcaRaqueta: formEditSolicitud.editSolicitudMarcaRaqueta.value.trim(),
            modeloRaqueta: formEditSolicitud.editSolicitudModeloRaqueta.value.trim(),
            tensionVertical: parseFloat(formEditSolicitud.editSolicitudTensionVertical.value),
            tensionHorizontal: parseFloat(formEditSolicitud.editSolicitudTensionHorizontal.value),
            tipoCuerda: formEditSolicitud.editSolicitudTipoCuerda.value.trim(),
            cuerdaIncluida: formEditSolicitud.editSolicitudCuerdaIncluida.checked,
            fechaSolicitud: parseDateInput(formEditSolicitud.editSolicitudFechaSolicitud.value),
            fechaEntregaEstimada: parseDateInput(formEditSolicitud.editSolicitudFechaEntregaEstimada.value),
            precio: formEditSolicitud.editSolicitudPrecio.value ? parseFloat(formEditSolicitud.editSolicitudPrecio.value) : null,
            estadoPago: formEditSolicitud.editSolicitudEstadoPago.value,
            estadoEntrega: formEditSolicitud.editSolicitudEstadoEntrega.value,
            notas: formEditSolicitud.editSolicitudNotas.value.trim()
        };

        // Validaciones
        const errors = validateForm(formData, [
            'marcaRaqueta', 'tensionVertical', 'tensionHorizontal', 
            'fechaSolicitud', 'estadoPago', 'estadoEntrega'
        ]);

        if (isNaN(formData.tensionVertical)) {
            errors.push("La tensión vertical debe ser un número válido");
            showError('editTensionVertical', "Debe ser un número válido");
        }

        if (isNaN(formData.tensionHorizontal)) {
            errors.push("La tensión horizontal debe ser un número válido");
            showError('editTensionHorizontal', "Debe ser un número válido");
        }

        if (!formData.fechaSolicitud) {
            errors.push("La fecha de solicitud no es válida");
            showError('editFechaSolicitud', "Fecha no válida");
        }

        if (errors.length > 0) {
            showModalMessage(errors.join("<br>"), "error");
            return;
        }

        try {
            const solicitudDocRef = doc(solicitudesCollectionRef, solicitudId);
            
            await updateDoc(solicitudDocRef, {
                ...formData,
                fechaSolicitud: Timestamp.fromDate(formData.fechaSolicitud),
                fechaEntregaEstimada: formData.fechaEntregaEstimada ? Timestamp.fromDate(formData.fechaEntregaEstimada) : null,
                fechaUltimaActualizacion: Timestamp.now()
            });
            
            showModalMessage("Solicitud actualizada correctamente.", "success");
            editSolicitudModal.style.display = 'none';
        } catch (error) {
            showModalMessage(`Error al actualizar solicitud: ${error.message}`, "error");
        }
    });

    window.confirmDeleteSolicitud = (solicitudId) => {
        showConfirmModal(
            "¿Está seguro de que desea eliminar esta solicitud de encordado? Esta acción no se puede deshacer.", 
            async () => {
                if (!isAuthReady) return;
                
                try {
                    await deleteDoc(doc(solicitudesCollectionRef, solicitudId));
                    showModalMessage("Solicitud eliminada correctamente.", "success");
                } catch (error) {
                    showModalMessage(`Error al eliminar solicitud: ${error.message}`, "error");
                }
            }
        );
    };

    // --- FUNCIONALIDAD PARA SELECCIONAR Y ELIMINAR MULTIPLES SOLICITUDES ---
    document.getElementById('selectAllSolicitudes').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.solicitud-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
    });

    document.getElementById('btnDeleteSelected').addEventListener('click', function() {
        const selectedIds = Array.from(document.querySelectorAll('.solicitud-checkbox:checked')).map(cb => cb.value);
        
        if (selectedIds.length === 0) {
            showModalMessage("Por favor seleccione al menos una solicitud para eliminar.", "warning");
            return;
        }
        
        showConfirmModal(
            `¿Está seguro de que desea eliminar las ${selectedIds.length} solicitudes seleccionadas? Esta acción no se puede deshacer.`, 
            async () => {
                if (!isAuthReady) return;
                
                try {
                    const batch = writeBatch(db);
                    
                    selectedIds.forEach(id => {
                        const docRef = doc(solicitudesCollectionRef, id);
                        batch.delete(docRef);
                    });
                    
                    await batch.commit();
                    showModalMessage(`${selectedIds.length} solicitudes eliminadas correctamente.`, "success");
                    
                    // Desmarcar "Seleccionar todos" después de eliminar
                    document.getElementById('selectAllSolicitudes').checked = false;
                } catch (error) {
                    showModalMessage(`Error al eliminar solicitudes: ${error.message}`, "error");
                }
            }
        );
    });

    // --- IMPORTAR/EXPORTAR CSV ---
    const btnExportCsv = document.getElementById('btnExportCsv');
    const btnImportCsv = document.getElementById('btnImportCsv');
    const importFile = document.getElementById('importFile');

    function escapeCsvCell(cellData) {
        if (cellData == null) return '';
        const stringData = String(cellData);
        if (stringData.includes(',') || stringData.includes('"') || stringData.includes('\n') || stringData.includes('\r')) {
            return `"${stringData.replace(/"/g, '""')}"`;
        }
        return stringData;
    }

    btnExportCsv.addEventListener('click', () => {
        if (!isAuthReady || currentSolicitudesData.length === 0) {
            showModalMessage("No hay datos de solicitudes para exportar o no está autenticado.", "warning");
            return;
        }
        
        const headers = [
            "id", "jugadorId", "nombreJugador", "marcaRaqueta", "modeloRaqueta", 
            "tensionVertical", "tensionHorizontal", "tipoCuerda", "cuerdaIncluida",
            "fechaSolicitud", "fechaEntregaEstimada", "precio", "estadoPago", 
            "estadoEntrega", "notas", "fechaCreacion", "fechaUltimaActualizacion"
        ];
        
        let csvContent = headers.map(escapeCsvCell).join(",") + "\r\n";
        
        currentSolicitudesData.forEach(solicitud => {
            const row = [
                solicitud.id, solicitud.jugadorId, solicitud.nombreJugador, 
                solicitud.marcaRaqueta, solicitud.modeloRaqueta,
                solicitud.tensionVertical, solicitud.tensionHorizontal, 
                solicitud.tipoCuerda, solicitud.cuerdaIncluida,
                formatDateForDisplay(solicitud.fechaSolicitud),
                formatDateForDisplay(solicitud.fechaEntregaEstimada),
                solicitud.precio, solicitud.estadoPago, 
                solicitud.estadoEntrega, solicitud.notas,
                formatDateForDisplay(solicitud.fechaCreacion), 
                formatDateForDisplay(solicitud.fechaUltimaActualizacion)
            ];
            
            csvContent += row.map(escapeCsvCell).join(",") + "\r\n";
        });
        
        const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `solicitudes_encordado_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showModalMessage("Datos exportados a CSV.", "success");
        } else {
            showModalMessage("La exportación CSV no es compatible con su navegador.", "error");
        }
    });

    btnImportCsv.addEventListener('click', async () => {
        if (!isAuthReady || !solicitudesCollectionRef) {
            showModalMessage("La base de datos no está lista o no está autenticado.", "error"); 
            return;
        }
        
        if (!importFile.files || importFile.files.length === 0) {
            showModalMessage("Por favor, seleccione un archivo CSV para importar.", "warning");
            return;
        }
        
        const file = importFile.files[0];
        const reader = new FileReader();
        
        reader.onload = async (event) => {
            try {
                const csvData = event.target.result;
                const lines = csvData.split(/\r\n|\n/);
                
                if (lines.length < 2) {
                    showModalMessage("El archivo CSV está vacío o no tiene datos.", "error");
                    return;
                }
                
                const expectedHeaders = [
                    "jugadorid", "nombrejugador", "marcaraqueta", "modeloraqueta", 
                    "tensionvertical", "tensionhorizontal", "tipocuerda", "cuerdaincluida",
                    "fechasolicitud", "fechaentregaestimada", "precio", "estadopago", 
                    "estadoentrega", "notas"
                ];
                
                const actualHeaders = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/"/g, ''));
                
                // Verificar encabezados
                let missingHeaders = [];
                const headerMap = {};
                
                expectedHeaders.forEach(expHeader => {
                    const index = actualHeaders.indexOf(expHeader);
                    if (index === -1) {
                        missingHeaders.push(expHeader);
                    } else {
                        headerMap[expHeader] = index;
                    }
                });
                
                if (missingHeaders.length > 0) {
                    showModalMessage(`Error: Faltan columnas en CSV: ${missingHeaders.join(", ")}`, "error");
                    return;
                }
                
                const batch = writeBatch(db);
                let importCount = 0;
                let errorCount = 0;
                const errors = [];
                
                // Procesar cada línea
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim() === '') continue;
                    
                    try {
                        const values = lines[i].split(',').map(v => v.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
                        
                        const cuerdaIncluidaStr = String(values[headerMap["cuerdaincluida"]]).toLowerCase();
                        const cuerdaIncluida = cuerdaIncluidaStr === 'true' || cuerdaIncluidaStr === 'verdadero' || cuerdaIncluidaStr === '1';
                        
                        // Parsear fechas (formato dd/mm/aaaa)
                        const fechaSolicitudParts = values[headerMap["fechasolicitud"]].split('/');
                        const fechaEntregaParts = values[headerMap["fechaentregaestimada"]]?.split('/') || [];
                        
                        let fechaSolicitud = null;
                        let fechaEntrega = null;
                        
                        if (fechaSolicitudParts.length === 3) {
                            fechaSolicitud = new Date(
                                parseInt(fechaSolicitudParts[2]),
                                parseInt(fechaSolicitudParts[1]) - 1,
                                parseInt(fechaSolicitudParts[0])
                            );
                        }
                        
                        if (fechaEntregaParts.length === 3) {
                            fechaEntrega = new Date(
                                parseInt(fechaEntregaParts[2]),
                                parseInt(fechaEntregaParts[1]) - 1,
                                parseInt(fechaEntregaParts[0])
                            );
                        }
                        
                        if (!fechaSolicitud || isNaN(fechaSolicitud.getTime())) {
                            errors.push(`Línea ${i+1}: Fecha de solicitud inválida (dd/mm/aaaa)`);
                            errorCount++;
                            continue;
                        }
                        
                        const solicitudData = {
                            jugadorId: values[headerMap["jugadorid"]] || null,
                            nombreJugador: values[headerMap["nombrejugador"]] || "N/A",
                            marcaRaqueta: values[headerMap["marcaraqueta"]] || "",
                            modeloRaqueta: values[headerMap["modeloraqueta"]] || "",
                            tensionVertical: parseFloat(values[headerMap["tensionvertical"]]) || null,
                            tensionHorizontal: parseFloat(values[headerMap["tensionhorizontal"]]) || null,
                            tipoCuerda: values[headerMap["tipocuerda"]] || "",
                            cuerdaIncluida: cuerdaIncluida,
                            fechaSolicitud: Timestamp.fromDate(fechaSolicitud),
                            fechaEntregaEstimada: fechaEntrega && !isNaN(fechaEntrega.getTime()) ? Timestamp.fromDate(fechaEntrega) : null,
                            precio: parseFloat(values[headerMap["precio"]]) || null,
                            estadoPago: values[headerMap["estadopago"]] || "Pendiente",
                            estadoEntrega: values[headerMap["estadoentrega"]] || "Pendiente",
                            notas: values[headerMap["notas"]] || "",
                            fechaCreacion: Timestamp.now(),
                            fechaUltimaActualizacion: Timestamp.now()
                        };
                        
                        if (!solicitudData.marcaRaqueta) {
                            errors.push(`Línea ${i+1}: Marca de raqueta es obligatoria`);
                            errorCount++;
                            continue;
                        }
                        
                        const newSolicitudRef = doc(collection(db, `users/${userId}/solicitudes`));
                        batch.set(newSolicitudRef, solicitudData);
                        importCount++;
                    } catch (parseError) {
                        console.error(`Error parseando línea ${i+1}:`, parseError);
                        errors.push(`Línea ${i+1}: Error formato (${parseError.message})`);
                        errorCount++;
                    }
                }
                
                if (importCount > 0) {
                    try {
                        await batch.commit();
                        let message = `${importCount} solicitudes importadas.`;
                        
                        if (errorCount > 0) {
                            message += ` ${errorCount} no importadas.`;
                        }
                        
                        showModalMessage(message, "success");
                        
                        if (errors.length > 0) {
                            console.warn("Errores de importación:\n" + errors.join("\n"));
                        }
                    } catch (commitError) {
                        console.error("Error guardando importados:", commitError);
                        showModalMessage(`Error guardando: ${commitError.message}`, "error");
                    }
                } else if (errorCount > 0) {
                    showModalMessage(`${errorCount} solicitudes no importadas. Errores: ${errors.slice(0,3).join('; ')}... (ver consola)`, "error");
                } else {
                    showModalMessage("No se importaron nuevas solicitudes.", "info");
                }
            } catch (error) {
                console.error("Error procesando CSV:", error);
                showModalMessage(`Error al procesar el archivo CSV: ${error.message}`, "error");
            } finally {
                importFile.value = '';
            }
        };
        
        reader.onerror = () => {
            showModalMessage("Error al leer el archivo.", "error");
            importFile.value = '';
        };
        
        reader.readAsText(file);
    });

    // --- EVENT LISTENERS PARA FILTROS ---
    document.getElementById('btnAplicarFiltros').addEventListener('click', loadSolicitudes);
    document.getElementById('btnLimpiarFiltros').addEventListener('click', () => {
        document.getElementById('filtroJugador').value = '';
        document.getElementById('filtroEstadoPago').value = '';
        document.getElementById('filtroEstadoEntrega').value = '';
        document.getElementById('filtroFechaSolicitudDesde').value = '';
        document.getElementById('filtroFechaSolicitudHasta').value = '';
        loadSolicitudes();
    });

    // --- ESTADÍSTICAS ---
    function calcularYMostrarEstadisticas() {
        if (!isAuthReady) return;
        
        const totalSolicitudes = currentSolicitudesData.length;
        const ingresosTotales = currentSolicitudesData.reduce((sum, s) => sum + (s.precio || 0), 0);
        const precioPromedio = totalSolicitudes > 0 ? ingresosTotales / totalSolicitudes : 0;
        
        const hoy = new Date();
        hoy.setHours(0, 0, 0, 0);
        const solicitudesHoy = currentSolicitudesData.filter(s => {
            const fecha = s.fechaSolicitud?.toDate();
            return fecha && fecha >= hoy;
        }).length;
        
        // Actualizar tarjetas
        document.getElementById('statTotalSolicitudes').textContent = totalSolicitudes;
        document.getElementById('statIngresosTotales').textContent = ingresosTotales.toFixed(2) + '€';
        document.getElementById('statPrecioPromedio').textContent = precioPromedio.toFixed(2) + '€';
        document.getElementById('statSolicitudesHoy').textContent = solicitudesHoy;
        
        // Actualizar gráficos
        actualizarGraficosEstadisticas();
    }

    function actualizarGraficosEstadisticas() {
        // Datos para gráficos
        const estadosPago = {
            Pendiente: 0,
            Pagado: 0
        };
        
        const estadosEntrega = {
            'Pendiente': 0,
            'En Proceso': 0,
            'Listo para Recoger': 0,
            'Entregado': 0,
            'Cancelado': 0
        };
        
        currentSolicitudesData.forEach(s => {
            estadosPago[s.estadoPago] = (estadosPago[s.estadoPago] || 0) + 1;
            estadosEntrega[s.estadoEntrega] = (estadosEntrega[s.estadoEntrega] || 0) + 1;
        });
        
        // Gráfico de estado de pago
        if (pagoChart) pagoChart.destroy();
        const pagoCtx = document.getElementById('pagoChart').getContext('2d');
        pagoChart = new Chart(pagoCtx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(estadosPago),
                datasets: [{
                    data: Object.values(estadosPago),
                    backgroundColor: [
                        '#f59e0b',
                        '#10b981'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
        
        // Gráfico de estado de entrega
        if (entregaChart) entregaChart.destroy();
        const entregaCtx = document.getElementById('entregaChart').getContext('2d');
        entregaChart = new Chart(entregaCtx, {
            type: 'pie',
            data: {
                labels: Object.keys(estadosEntrega),
                datasets: [{
                    data: Object.values(estadosEntrega),
                    backgroundColor: [
                        '#ef4444',
                        '#3b82f6',
                        '#8b5cf6',
                        '#10b981',
                        '#9ca3af'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
        
        // Gráfico de ingresos mensuales
        const ingresosPorMes = {};
        currentSolicitudesData.forEach(s => {
            if (s.fechaSolicitud && s.precio) {
                const fecha = s.fechaSolicitud.toDate();
                const mes = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}`;
                ingresosPorMes[mes] = (ingresosPorMes[mes] || 0) + (s.precio || 0);
            }
        });
        
        const meses = Object.keys(ingresosPorMes).sort();
        const ingresos = meses.map(mes => ingresosPorMes[mes]);
        
        if (ingresosChart) ingresosChart.destroy();
        const ingresosCtx = document.getElementById('ingresosChart').getContext('2d');
        ingresosChart = new Chart(ingresosCtx, {
            type: 'bar',
            data: {
                labels: meses,
                datasets: [{
                    label: 'Ingresos (€)',
                    data: ingresos,
                    backgroundColor: '#3b82f6',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
        
        // Gráfico de solicitudes por jugador (Top 5)
        const jugadoresCount = {};
        currentSolicitudesData.forEach(s => {
            const jugador = s.nombreJugador || s.jugadorId;
            jugadoresCount[jugador] = (jugadoresCount[jugador] || 0) + 1;
        });
        
        const jugadoresSorted = Object.entries(jugadoresCount)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5);
        
        const nombresJugadores = jugadoresSorted.map(j => j[0]);
        const countSolicitudes = jugadoresSorted.map(j => j[1]);
        
        if (jugadoresChart) jugadoresChart.destroy();
        const jugadoresCtx = document.getElementById('jugadoresChart').getContext('2d');
        jugadoresChart = new Chart(jugadoresCtx, {
            type: 'bar',
            data: {
                labels: nombresJugadores,
                datasets: [{
                    label: 'Solicitudes',
                    data: countSolicitudes,
                    backgroundColor: '#8b5cf6',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    // --- INICIALIZACIÓN ---
    async function loadInitialData() {
        try {
            await loadJugadoresParaDropdown();
            await loadJugadoresParaFiltros();
            await loadJugadoresParaLista();
            await loadSolicitudes();
            
            // Configurar fecha actual por defecto en nueva solicitud
            document.getElementById('solicitudFechaSolicitud').valueAsDate = new Date();
            actualizarPrecioSugerido('solicitud');
        } catch (error) {
            console.error("Error cargando datos iniciales:", error);
            showModalMessage("Error al cargar datos iniciales", "error");
        }
    }

    // Iniciar la aplicación cuando el DOM esté listo
    document.addEventListener('DOMContentLoaded', () => {
        initApplication();
    });
    </script>
</body>
</html>
